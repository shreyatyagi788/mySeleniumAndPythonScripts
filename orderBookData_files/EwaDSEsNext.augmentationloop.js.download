'use strict';(window.dullscriptWebpackJsonp=window.dullscriptWebpackJsonp||[]).push([[16],{1183:function(r,F,a){function c(X){return I.Range.Mc(X.row+1,X.col+1)}var b=a(9);r=a(0);var e=a(15),f=a(709),d=a(50),h=a(37),l=a(1306),k=a(1),t=a(994),n=a(250),z=a(94);class w extends t.a{constructor(X){super(X,w.featureName)}static init(X){w.La?e.ULS.sendTraceTag(522782307,1,15,"FormulaSuggestionUIControl.init: unexpected call after already being inited."):w.La=new w(X)}static instance(){return w.La}get Xd(){return n.a.OZe}show(X,
R,wa,na,Ba,Ra=null,qa=null){this.u9f(qa,La=>{appChrome.renderFormulaSuggestionCard(X,R,this.domElement,La.y,La.x,La.y+La.height,La.x+La.width,wa,na,Ba,Ra,this.l6f)})}Yda(X,R,wa){k.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.FBECurtainLifterCalloutForTestingOnlyEnabled",!1)&&(this.y1a&&X.equals(this.Dyi)||(this.y1a&&document.body.removeChild(this.y1a),this.Dyi=X,X=this.grid.Pb(X),X=this.grid.getCellBounds(X.cell,!0),this.y1a=document.createElement("div"),this.y1a.setAttribute("style",
`position:fixed;
        left: ${X.x+X.width}px;
        top: ${X.y+X.height/2}px`),document.body.appendChild(this.y1a)),X=new z.a(-847286761,0,this.$.xc,0,null),this.$.Ia.Hb(X,{["CalloutName"]:15,["Target"]:this.y1a,["NewState"]:R,["Reason"]:wa}))}}Object(r.a)(w,"FormulaSuggestionUIControl",t.a,[281]);var m=a(204),u=a(105),y=a(187);class v extends f.a{constructor(X){super(X)}hd(){e.ULS.sendTraceTag(528758224,0,50,"FormulaByExampleCommandHandlerFactory.CreateCommandHandlersAsync: FormulaByExampleCommandHandler init flow started.");const X=d.GetServiceTaskFactory.Oa(this.$.da,
453,454,1);let R;R=k.EwaSettings.dK()?Object(m.c)(y.a.resolve(u.b,{Tl:1})):d.GetServiceTaskFactory.Oa(this.$.da,266,265,1);h.TaskExtensions.za(h.TaskExtensions.Fd([X,R],this.la),()=>{const wa=this.$.da.Aa(328);this.$c([new l.a(this.$,wa,R.result,X.result,w.instance())]);e.ULS.sendTraceTag(537161924,0,50,"FormulaByExampleCommandHandlerFactory.CreateCommandHandlersAsync: FormulaByExampleCommandHandler initialized successfully")},this.la)}static ka(X){f.a.Md(455,new v(X))}}Object(r.a)(v,"FormulaByExampleCommandHandlerFactory",
f.a,[]);var C=a(55);t=a(226);var x=a(7),B=a(835),H=a(5),I=a(24),U=a(33),S=a(8);class G{constructor(X,R,wa){this.kind=X;this.value=R;this.formatted=wa}get displayText(){var X;return null!==(X=this.formatted)&&void 0!==X?X:this.value}}Object(r.a)(G,"CloneEvaluatedEdit",null,[]);class D{constructor(X,R=null,wa){this.status=X;this.gad=R;this.Ksc=wa}}Object(r.a)(D,"FormulaByExampleFormulaEvalResult",null,[]);var E=a(22),N=a(21),M=a(870),L=a(61);class aa{constructor(X,R,wa,na){this.k8f=this.Wif=this.BB=
!1;this.$=X;this.calcManager=R;this.BB=na;this.Nh=wa;this.Hk=M.a.getInstance(this.$);this.gridView=N.h(this.$);this.Wif=k.EwaSettings.isChangeGateEnabled("OfficeVSO:6327953_FormatOutputResultsOfFBE_V2");this.k8f=k.EwaSettings.isChangeGateEnabled("OfficeVSO:7549840_DontShowFBESuggestionsWithErrorInTriggerCell")}kzj(X,R,wa=null,na=!1,Ba){R=X.range.we(R);return R?this.LQe(X,R,wa).then(Ra=>{this.BB&&!na&&X.flowId&&Object(B.f)("CALCULATIONED",X.flowId,Ba);if(2===Ra.status)return Ra;e.ULS.sendTraceTag(537161881,
0,50,"FormulaByExampleModelUpdater:setFormulaPreviewOnRangeModel: evalFormulaRangeOnClone CSE: Result received from calc.");return this.p0j(Ra,na,X.flowId,Ba)}).catch(Ra=>{Object(B.h)(X,`failed to setFormulaPreviewOnRangeModel, error in calc API: ${Ra.toString()}`,this.Hk,8);return Promise.reject(`FormulaByExampleModelUpdater:setFormulaPreviewOnRangeModel: Unable to EvalFormulaRange, e: ${Ra.toString()}`)}):(Object(B.h)(X,"Annotation range does not intersect loaded range",this.Hk,6),Promise.reject("FormulaByExampleModelUpdater:setFormulaPreviewOnRangeModel: Annotation range does not intersect loaded range."))}LQe(X,
R,wa=null){wa=aa.ZJh(wa);this.Hk.xo(X.flowId,7);return this.calcManager.Lub(wa,R,X.originCell,X.formula).then(na=>{if(!this.zpi(na))return Object(B.h)(X,"Result object from EvalOnClone API is empty or null.",this.Hk,8),new D(2);if(!this.MQg(na,X))return e.ULS.sendTraceTag(527005663,0,50,"FormulaByExampleModelUpdater:EvalFormulaRangeOnClone: Formula results from Calc.ts had errors."),new D(2);const Ba=this.M4j(na,X);if(!Ba.success)return Object(B.h)(X,`Evaluated results from calc do not match the user data in the grid or had errors from calc. reason: ${Ba.reason}`,
this.Hk,8),e.ULS.sendTraceTag(537161880,0,50,"FormulaByExampleModelUpdater:EvalFormulaRangeOnClone:Formula results from Calc.ts do not match grid data."),new D(2);this.Hk.xo(X.flowId,11);e.ULS.sendTraceTag(537161879,0,50,"FormulaByExampleModelUpdater:EvalFormulaRangeOnClone: EvalFormulaRange CSE: Result received from calc.");return new D(0,na.results,Ba.Ksc)}).catch(na=>{Object(B.h)(X,`failed to EvalFormulaRangeOnClone, error in calc API: ${na.toString()}`,this.Hk,8);return Promise.reject(`FormulaByExampleModelUpdater:EvalFormulaOnRange: Unable to EvalFormulaRange, e: ${na.toString()}`)})}zSg(X,
R){if(X)for(const na of X)if(excelOnlineCalc.util.isSuccess(na)){X=na;var wa=c(X.value[0]);if(wa=this.gridView.Pb(wa))wa=wa.cell,wa.text=this.ngd(X).displayText,wa.formulaBarText=R}}static ZJh(X){const R=wa=>({row:wa.cell.CQ,column:wa.cell.BQ,Gr:wa.Gr,formulaBarText:wa.Gr.value,text:wa.cell.text,hj:wa.cell.hj});return X?X.map(R):null}MQg(X,R){if(k.EwaSettings.isChangeGateEnabled("OfficeVSO:6669310_FBEShowsSuggestionsWithCalcFailures"))return!0;for(const wa of X.results){const {isSuccess:na,T$c:Ba,
reason:Ra}=this.qKh(wa);if(!na)return Object(B.h)(R,`Calc failed to evaluate formula. reason json: ${Ra} did result in error for formula output (#VALUE, #REF etc..): ${Ba}`,this.Hk,8),!1}return!0}zpi(X){return(X=X.results)&&X.length?!0:!1}qKh(X){if(excelOnlineCalc.util.isSuccess(X)){const R=X.value[1];return 8===R.kind?(X=c(X.value[0]),(X=this.gridView.Pb(X))&&X.cell.text&&e.ULS.shipAssertTag(537161878,0,!1,"FormulaByExampleModelUpdater:FormulaCalculationSucceeded: formula evaluation failed, bad formula provided"),
{isSuccess:!1,T$c:!0,reason:JSON.stringify(R.type)}):{isSuccess:!0,T$c:!1,reason:null}}return{isSuccess:!1,T$c:!1,reason:JSON.stringify(X.reason)}}p0j(X,R,wa,na){var Ba=X.gad;for(const Ra of Ba)excelOnlineCalc.util.isSuccess(Ra)?(Ba=Ra.value[0])?(Ba=c(Ba),(Ba=this.gridView.Pb(Ba))?(Ba.cell.Msc=this.ngd(Ra).displayText,X.status|=1):X.status|=2):X.status|=2:"Unavailable"!==Ra.reason.kind&&(X.status|=2);this.BB&&!R&&wa&&Object(B.f)("MODELUPDATED",wa,na);return X}M4j(X,R){let wa=null,na=!1,Ba=!1,Ra=!1,
qa=!1,La=!1,Yb=!1;X=X.results;var mc=X.entries();for(const Zb of mc){mc=Zb[0];const qb=this.N4j(Zb[1],R);qb.d8a&&(na=qb.T7b);qb.Qtd&&(Ba=!0,Ra||(Ra=qb.isInViewport),La||(La=qb.isInViewport&&!qb.hBb));qa||(qa=qb.hBb);Yb||(Yb=qb.Waf);wa=null!==wa&&void 0!==wa?wa:qb.oHa;(qb.Qtd||qb.hBb)&&X.splice(mc,1)}na?this.Hk.xo(R.flowId,10):this.Hk.xo(R.flowId,9);return wa?{success:!1,reason:wa}:{success:!0,Ksc:{["hasUnavailableCells"]:Ba,["hasUnexpectedUnavailableCellsInViewport"]:La,["hasHiddenRows"]:qa,["hasUnavailableCellsInViewport"]:Ra,
["hasErrorCells"]:Yb}}}N4j(X,R){var wa;const na={d8a:!1,Qtd:!1,isInViewport:!1,hBb:!1,oHa:null,Waf:!1,T7b:!1};if(!excelOnlineCalc.util.isSuccess(X)){var Ba=X.reason;X=I.Range.Mc(Ba.cell.row+1,Ba.cell.col+1);na.d8a=X.equals(R.originCell);this.wXe(na,X);if(k.EwaSettings.isChangeGateEnabled("OfficeVSO:6669310_FBEShowsSuggestionsWithCalcFailures")){if("Unavailable"===Ba.kind)return na.Qtd=!0,na;na.oHa=JSON.stringify({kind:Ba.kind,innerKind:Ba.innerKind})}na.oHa=null!==(wa=na.oHa)&&void 0!==wa?wa:"failure in calc";
return na}Ba=c(X.value[0]);na.d8a=Ba.equals(R.originCell);this.wXe(na,Ba);wa=this.gridView.Pb(Ba);if(!wa){if(na.isInViewport&&!na.hBb)return na.oHa="formatted grid cell is null",na;e.ULS.sendTraceTag(509682371,0,50,"FormulaByExampleModelUpdater:validateCalcResultMatchesCellData: did not fail suggestion when a formatted grid cell is null as this cell is hidden or not in view.");return na}var Ra=this.ngd(X,this.Wif?wa:null,R.$Ke);if(8===Ra.kind)return na.Waf=!0,this.k8f&&na.d8a&&(na.oHa=`suggestion has error of kind ${Ra.value} in cell.`),
na;X=wa.text;if(!X)return na.T7b=!0,na;Ra=Ra.displayText;na.T7b=E.a.equals(X,Ra,!1);na.T7b||(Ba=R.rif(Ba)?na.d8a?"MODIFIEDEXAMPLE":"EXAMPLE":na.d8a?"MODIFIEDRESTOFRANGE":"RESTOFRANGE",Object(B.g)(X,Ra.toString(),wa.cell.hj,"evalFormulaOnCloneToShowPreview",R,Ba),na.oHa="data strings do not match");return na}wXe(X,R){X.isInViewport=this.gridView.aN(R);const wa=this.gridView.Mj("FormulaByExample");Object(L.a)(wa);X.hBb=wa.value.zBb(R)}QJh(X,R,wa){X=this.Nh.CZe(X,R.cell.hj,0===R.cell.oC?wa:R.cell.oC,
R.cell.rBa,R.cell.bia);if(X.success)return X.KA;e.ULS.sendTraceTag(509694294,0,50,"FormulaByExampleModelUpdater:formatCloneResult: formatCellsAction failed to format clone result according to cell format.");return null}ngd(X,R,wa){X=X.value[1];var na=1===X.kind?X._valueXL.toString():8===X.kind?S.a.V$c[X.type-1]:X.value;R&&!X.formattedText&&(X.formattedText=this.QJh(na,R,wa));return new G(X.kind,na,X.formattedText)}}Object(r.a)(aa,"FormulaByExampleModelUpdater",null,[]);var V=a(167),P=a(736),ba=a(713);
class Y extends P.a{constructor(){super();this.rows=null;this.column=0;this.generatedFormula=this.formulas=null;this.resultKind=this.invocationMethod=this.stateID=0;this.errorMessage=this.guid=null;this.H_=Object.assign(new ba.a,{T_:Y.getTypeName(),B_:Y.Kd()})}static getTypeName(){return"AugLoop_FormulaByExample_FormulaByExampleAnnotation"}static Kd(){return["AugLoop_Core_Annotation"]}}Object(r.a)(Y,"FormulaByExampleAnnotation",P.a,[]);class Z extends Y{constructor(X,R,wa,na){super();Object.assign(this,
R);this.$=X;this.M9d=wa;na&&(this.kWb=na.range,this.Evg=na.valueType);this.Lca={flowId:this.flowId,CJ:this.CJ,originCell:this.originCell,anonymizedFormula:this.anonymizedFormula}}set flowId(X){this.M9d=X}get flowId(){return this.M9d}get formula(){var X;void 0===this.eWa&&(this.eWa=null===(X=this.generatedFormula)||void 0===X?void 0:X.formula)&&"="!==this.eWa.charAt(0)&&(e.ULS.sendTraceTag(509620492,306,50,"FormulaByExampleSuggestion.formula: appending = sign as formula prefix."),this.eWa=`=${this.eWa}`);
return this.eWa}set CJ(X){this.uKc=X}get rbd(){return this.rows}get $Ke(){return this.Evg}get anonymizedFormula(){var X;void 0===this.W9d&&(this.W9d=null===(X=this.generatedFormula)||void 0===X?void 0:X.anonymizedFormula);return this.W9d}get CJ(){void 0===this.uKc&&(this.uKc=this.rbd.length);return this.uKc}set originCell(X){this.kWb=X}get originCell(){void 0===this.kWb&&(e.ULS.sendTraceTag(509620491,306,10,`FormulaByExampleSuggestion.originCell: origin cell is not defined - falling back to first cell of annotation range. flowId: ${this.flowId}`),
this.kWb=I.Range.Mc(this.rbd[0],this.column));return this.kWb}get range(){return new I.Range(this.Cdg.top,this.column,this.Cdg.bottom,this.column,!0,!0)}rif(X){return X.zd(this.range)&&this.rbd.includes(X.top)}}Object(r.a)(Z,"FormulaByExampleSuggestionBase",Y,[]);class ea extends Z{constructor(X,R,wa,na){super(X,R,wa,na)}get table(){void 0===this.Rmb&&(this.Rmb=Object(N.h)(this.$).tb.Dh(this.originCell,!1));return this.Rmb}get Cdg(){return this.table?Object(V.a)(this.table):null}}Object(r.a)(ea,"FormulaByExampleTableSuggestion",
Z,[]);var ra;(function(X){X.accept="ACCEPT";X.decline="DECLINE";X.ignore="IGNORE"})(ra||(ra={}));Object(r.b)("PreviewOutcome",ra);var O;(O||(O={})).unseen="UNSEEN";Object(r.b)("EntryState",O);const da=Object.assign(Object.assign({},O),ra);class xa{constructor(X){this.state=da.unseen;this.hxc=0;this.suggestion=X}bfi(){this.hxc+=1}}Object(r.a)(xa,"SuggestionEntryInternal",null,[]);class ia extends Map{G2b(X){const R=this.F4a(X);if(!R)return null;let wa=this.get(R);wa||(wa=[],this.set(R,wa));X=new xa(X);
wa.push(X);return X}lLe(X){const R=this.qxb(X);R&&(X=this.F4a(X),X=this.get(X),X.splice(X.indexOf(R)))}t2j(X){const R=this.qxb(X);R&&(R.suggestion=X);return R}}Object(r.a)(ia,"SuggestionsCache",Map,[]);class Ma extends ia{yUh(X){var R;return null===(R=super.get(X))||void 0===R?void 0:R[0]}qxb(X){return(X=this.F4a(X))?this.has(X)?this.get(X)[0]:null:null}G2b(X){const R=this.F4a(X);if(!R)return null;X=new xa(X);this.set(R,[X]);return X}lLe(X){(X=this.F4a(X))&&this.delete(X)}}Object(r.a)(Ma,"SingularSuggestionsCache",
ia,[]);class Ta extends Ma{constructor(X,R){super();this.calcManager=X;this.JJ=R}G2b(X){var R;let wa=!1;const na=super.qxb(X);if(!na||(wa=na.suggestion.formula!==X.formula))return wa&&e.ULS.sendTraceTag(523842004,306,20,`FormulaByExampleSuggestionsCache.cacheSuggestion: formula changed from last cache entry, overriding cache entry.
           Last example count: ${na.suggestion.CJ}, current: ${X.CJ}, oldFormula: ${na.suggestion.anonymizedFormula}, newFormula:${X.anonymizedFormula}`),e.ULS.sendTraceTag(537161877,306,20,`FormulaByExampleSuggestionsCache.cacheSuggestion: saving suggestion for table range. tableRange: ${null===(R=X.table)||void 0===R?void 0:R.usedRange}, columnNumber: ${X.column}, examplesCount ${X.CJ}, hasPreviousSuggestion: ${this.has(this.F4a(X))}`),(R=super.G2b(X))||e.ULS.sendTraceTag(528889932,306,15,"SuggestionsCache.cacheSuggestion: failed to cache table suggestion due to getTableColumnKey failure."),
this.JJ.Yda(X.originCell,3),R;na.suggestion.CJ!==X.CJ&&(e.ULS.sendTraceTag(523842003,306,50,`FormulaByExampleSuggestionsCache.cacheSuggestion: formula didn't change from the last cache entry, but number of examples changed. Last example ${na.suggestion.CJ}, current: ${X.CJ}`),this.JJ.Yda(X.originCell,4),X.Lca.CJ=na.suggestion.Lca.CJ);return this.t2j(X)}qxb(X){const R=super.qxb(X);return E.a.equals(null===R||void 0===R?void 0:R.suggestion.formula,X.formula,!0)?R:null}g8e(X,R){X=this.J8e(X,R);return X?
this.yUh(X):(e.ULS.sendTraceTag(528889931,306,15,"FormulaByExampleSuggestionsCache.getTableCachedSuggestion: failed to get cached table suggestion due to getTableColumnKey failure."),null)}F4a(X){return this.J8e(X.table,X.column)}J8e(X,R){const wa=this.calcManager.byb(X);if(!wa)return null;const na=X.usedRange,Ba=R-na.left;(0>Ba||Ba>=wa.count)&&e.ULS.sendTraceTag(537161876,306,10,`FormulaByExampleSuggestionCache.getUniqueTableColumnIdentifier: invalid inputs. tableRange: ${na}, columnNumber: ${R}, `+
`areAllTableHeadersAvailable: ${this.calcManager.Nse(X,wa)}`);return(R=wa.ma(Ba))?X.name+"_"+R:null}}Object(r.a)(Ta,"FormulaByExampleTableSuggestionsCache",Ma,[]);var Da=a(267),fa=a(65),ua=a(180),Fa=a(123),ca=a(886),ka=a(995),Ca=a(885),fb=a(427);class yb{constructor(X,R,wa,na,Ba){this.FH=this.JJ=this.tOb=this.rnc=null;this.dNa=this.BB=!1;this.VPa=null;this.OUd=!1;this.Gvb=null;this.e9f=!1;this.vvf=2E3;this.RPi=Ra=>{e.ULS.sendTraceTag(520987789,306,50,`FormulaByExampleManager.onCloseCallback: closeReason = ${Ca.a[Ra]}`)};
this.pKh=(Ra,qa)=>{e.ULS.sendTraceTag(528758222,306,50,"FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation received.");if(Ra=qa.BG){if(qa=parseInt(Ra.guid,10),!k.EwaSettings.isChangeGateEnabled("OfficeVSO:7417755_FormulaByExampleVerifyDuplicatedAnnotation")||this.Hk.Nif(qa))if(Ra=new ea(this.$,Ra,qa,this.r6i(qa)),e.ULS.sendTraceTag(526984792,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: received annotation's flowId: ${Ra.flowId}.`),this.Hk.xo(Ra.flowId,14),
this.BB&&!this.dNa&&Object(B.f)("ANNOTATIONRECEIVED",Ra.flowId),null!=Ra.errorMessage)e.ULS.sendTraceTag(527005666,306,10,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation arrived with error message: ${Ra.errorMessage}, flowId: ${Ra.flowId}`),this.Hk.xo(Ra.flowId,15,{reason:"Annotation arrived with error message"});else if(Ra.formula)if(e.ULS.sendTraceTag(509679808,306,20,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation with a formula suggestion arrived. flowId: ${Ra.flowId}`),
this.Hk.xo(Ra.flowId,16,{Snc:Ra.formula}),Ra.table)if(this.FH=Ra,qa=this.tOb.G2b(Ra))if(this.e9f||1!==Ra.invocationMethod)if(Ra.CJ<ca.a)e.ULS.sendTraceTag(528758220,306,50,"FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation does not have enough examples to prompt a suggestion.");else if(e.ULS.sendTraceTag(527005665,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation with formula suggestion arrived. trying to suggest/apply it. flowID: ${Ra.flowId}`),0===
Ra.invocationMethod)this.jzj(Ra);else{var La=Object(B.c)(Ra.flowId);La>this.vvf?(e.ULS.sendTraceTag(509636688,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation arrived after the maximal wait time for suggestions. flowId: ${Ra.flowId}, duration: ${La}`),this.Hk.xo(Ra.flowId,6,{reason:"annotation arrived after the maximal wait time for suggestions"})):(La=this.c9f(qa),La.value?this.Ogg(qa,!1,"UponAnnotationReceived"):(e.ULS.sendTraceTag(509636687,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: shouldShowPreview returned false for suggestion with flowId: ${Ra.flowId}, reason: ${La.reason}`),
this.Hk.xo(Ra.flowId,6,{reason:La.reason})))}else e.ULS.sendTraceTag(523850754,306,50,"FormulaByExampleManager.formulaByExampleAnnotationHandler: session supports suggestions from cache only. returning early after caching suggestion.");else e.ULS.sendTraceTag(509678998,306,15,`FormulaByExampleManager.formulaByExampleAnnotationHandler: failed to cache suggestion for flowId: ${Ra.flowId}.`);else e.ULS.sendTraceTag(509690137,306,10,"FormulaByExampleManager.formulaByExampleAnnotationHandler: session supports suggestions on tables only - but no table was found.");
else{e.ULS.sendTraceTag(528758221,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation does not have any formula suggestions. flowId: ${Ra.flowId}`);if(qa=this.tOb.g8e(Ra.table,Ra.column))this.tOb.lLe(qa.suggestion),e.ULS.sendTraceTag(512258437,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: existing suggestion cache entry deleted. flowId: ${Ra.flowId}`);this.JJ.Yda(Ra.originCell,2);this.Hk.xo(Ra.flowId,15)}}else e.ULS.sendTraceTag(537161922,306,15,"FormulaByExampleManager.formulaByExampleAnnotationHandler: annotation is null.")};
this.ivj=()=>{e.ULS.sendTraceTag(537161889,306,50,"FormulaByExampleManager.SendByExampleFeedback: opening send feedback dialog after click on card.");const Ra={};Ra[H.a.wM]="FormulaByExampleCard";this.$.Yc(802602464,0,8,Ra)};this.t_i=Ra=>{this.OUd=!0;e.ULS.sendTraceTag(537161888,306,50,`FormulaByExampleManager.OnShowFormula: user clicked ShowFormula button in the card for flow ${Ra}`)};this.q$h=Ra=>{e.ULS.sendTraceTag(528758219,306,50,"FormulaByExampleManager.HandleNewBlocksDuringPreview: new block arrived during preview mode.");
var qa=Ra.Xc.block,La=Object(V.a)(this.FH.table);const Yb=this.FH.range.we(qa.De);La=(new I.Range(La.top,La.left,La.bottom,La.right,!0,!0)).we(qa.De);qa=Array.from(this.gridView.Bja(La,qa));e.ULS.sendTraceTag(537161886,306,50,`FormulaByExampleManager.HandleNewBlocksDuringPreview: putting skeleton for preview cells in new block ${Ra.Xc.hash}.`);this.O0d(Yb,!0);this.MQe(this.FH,La,qa).then(mc=>{e.ULS.sendTraceTag(537161885,306,50,`FormulaByExampleManager.HandleNewBlocksDuringPreview: putting calculated data into model and demanding re-render for block ${Ra.Xc.hash}.`);
this.O0d(Yb,!1);this.JN.Ouf(Ra.Xc.block);e.ULS.sendTraceTag(512508567,306,50,`FormulaByExampleManager.handleNewBlocksDuringPreview: new FormulaByExample suggestion block rendered during preview. results: ${JSON.stringify({["flowId"]:this.FH.flowId,["originalFlowId"]:this.FH.Lca.flowId,["formulaAnonymized"]:this.FH.anonymizedFormula,["originalFormulaAnonymized"]:this.FH.Lca.anonymizedFormula,["annotationRange"]:this.FH.range.toString(),["previewCellsMetadata"]:mc.Ksc})}`);return!0}).catch(mc=>{Object(B.h)(this.FH,
`Exception when rendering new block during preview. ${mc}`);e.ULS.sendTraceTag(537161884,306,50,`FormulaByExampleManager.HandleNewBlocksDuringPreview: caught exception: ${mc}.`)})};this.sVf=()=>{this.$.userOperationManager.Un(this.jEd);this.jEd=null};this.bPa=(Ra,qa)=>{0==qa.Iq&&(this.dNa&&this.VPa.kka(`UserOperation: ${Fa.a(qa.Lf.operation.operationName)}`),this.$.userOperationManager.Un(this.bPa))};this.mVi=(Ra,qa)=>{e.ULS.sendTraceTag(528023709,306,20,`FormulaByExampleManager.onImmediateUndo: undo operation queued following a formula by example suggestion application. flowId=${Ra} originalFlowId=${qa}`)};
this.$=X;this.e9f=k.EwaSettings.isChangeGateEnabled("OfficeVSO:6169955_ShowFormulaByExampleSuggestionsUponArrivalFromServer");this.vvf=k.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.FormulaByExampleMaximalWaitingTimeForSuggestionsMs",2E3);this.augmentationLoopManager=R;this.calcManager=wa;this.Nh=na;this.Gvb=new Map;this.gridView=Object(N.h)(this.$);this.JJ=Ba;this.Hk=M.a.getInstance(this.$);this.JN=this.gridView.JN;this.CHd=!1;U.a.aic(this.$)?this.init():e.ULS.sendTraceTag(537161923,306,
10,"FormulaByExampleManager.Ctor: not expected to be constructed when FG is off.")}i1i(X,R,wa,na){var Ba;const Ra=null===(Ba=this.gridView.Pb(X))||void 0===Ba?void 0:Ba.cell.oC;this.Gvb.set(R,{range:X,v9j:wa,valueType:Ra});wa?(this.CHd=!1,(wa=this.gridView.tb.Dh(X,!1))?(wa=this.tOb.g8e(wa,X.left))?(this.Hk.xo(R,4),Ba=this.c9f(wa),Ba.value?(wa.suggestion.flowId=R,wa.suggestion.originCell=X,e.ULS.sendTraceTag(529109774,306,50,"FormulaByExampleManager.onTableInput: A cached formula suggestion found for current input."),
this.Ogg(wa,!0,Object(fb.a)(na))):(this.Hk.xo(R,6,{reason:Ba.reason}),this.t5j(R,wa.suggestion,X))):this.Hk.xo(R,5):e.ULS.sendTraceTag(509649310,306,10,`FormulaByExampleManager.onUserInput: getTableContainingRange returned null. flowId: ${R}, editedCellRange: ${X}`)):e.ULS.shipAssertTag(524940241,306,!1,"FormulaByExampleManager.onUserInput: expected to be called on tables only.")}t5j(X,R,wa){k.EwaSettings.isChangeGateEnabled("OfficeVSO:7041480_FormulaByExampleFlowAggregatorFixed")&&this.calcManager.evalFormula(R.formula,
wa,fa.d(this.$.na),excelOnlineCalc.calc.evalFormulaFormatOrigin()).then(na=>{var Ba=this.gridView.Pb(wa);const Ra=Ba.text;Ba=Ba.cell.hj;na=na.value.value.toString();E.a.equals(Ra,na,!1)?this.Hk.xo(X,10):(Object(B.g)(Ra,na,Ba,"evalFormulaToVeriySuggestionWithoutShowingPreview",R,R.rif(wa)?"MODIFIEDEXAMPLE":"MODIFIEDRESTOFRANGE"),this.Hk.xo(X,9))}).catch(na=>{na=`Failed to evalFormula, error in calc API: ${na.toString()}`;e.ULS.sendTraceTag(512341207,306,50,`FormulaByExampleMangaer.verifySuggestionOnEditedCell: ${na}`);
this.Hk.xo(X,9,{reason:na})})}dispose(){this.$.userOperationManager.Un(this.bPa);this.sVf();this.augmentationLoopManager.unregister("FormulaByExample")}init(){const {FormulaByExampleAutoSuggestActor:X}=a(1345);this.augmentationLoopManager.register(this.augmentationLoopManager.a4a().Kdb("FormulaByExample").Hdb(this.RPi).activateAnnotation({annotationType:Y.getTypeName(),iz:!1,zV:this.pKh}).build());this.BB=Object(B.a)(this.$);new X(this.$,this.calcManager,this.BB);this.tOb=new Ta(this.calcManager,
this.JJ);this.rnc=new aa(this.$,this.calcManager,this.Nh,this.BB);e.ULS.sendTraceTag(528758223,306,50,"FormulaByExampleManager.init: init complete.")}r6i(X){if(!this.Gvb.has(X))return null;const R=this.Gvb.get(X);this.Gvb.delete(X);return R}jzj(X){this.rnc.LQe(X,X.range,null).then(R=>{this.bZc(X,1===R.status?R.gad:null);return null}).catch(()=>{e.ULS.sendTraceTag(537161921,306,50,"FormulaByExampleManager.setFormulaOnRangeExplicit: client estimation failed for explicit by example flow.");this.bZc(X,
null)})}Ogg(X,R,wa){e.ULS.sendTraceTag(527713160,306,20,`FormulaByExampleManager.tryDisplayFormulaSuggestionPreview: starting flow to show a formula suggestion. isFromCache: ${R}`);const na=X.suggestion;this.BB&&!this.dNa&&Object(B.f)("CALCULATIONSTART",na.flowId,R);var Ba=k.EwaSettings.isChangeGateEnabled("OfficeVSO:7189977_SendCloneUpdatesOnPreview")?this.m3e(Object(V.a)(na.table)):null;Ba=this.MQe(na,this.gridView.hi,Ba,R);const Ra=Ba.then(()=>this.JN.$na(na.range,this.q$h).then(qa=>{this.dNa=
!0;this.VPa=qa;this.$.userOperationManager.Zq(this.bPa);this.JJ.show(na.formula,na.range.toString(),()=>qa.rZb("CardUI"),()=>qa.g7b("CardUI"),this.ivj,()=>this.t_i(na.flowId),na.originCell);this.JJ.Yda(na.originCell,0);this.BB&&ua.a(()=>{Object(B.f)("PREVIEWRENDERED",na.flowId,R);const La=Object(B.e)(R,na.flowId);e.ULS.sendTraceTag(529109772,306,50,`FormulaByExampleManager.TryDisplayFormulaSuggestionPreview: durations for preview shown flow: ${JSON.stringify(La)}`)},this.$.la);return qa.hqj}));Promise.all([Ba,
Ra]).then(qa=>{this.CHd=!0;this.G$h(qa[0],qa[1],X,R,wa)}).catch(qa=>{Object(B.h)(na,`Failed to show formula preview due to a promise (model update or preview render) rejection. rejection reason: ${qa}`);e.ULS.sendTraceTag(537161920,306,15,`FormulaByExampleManager.TryDisplayFormulaSuggestionPreview: failed to show formula preview due to promise rejection. rejection reason: ${qa}`);this.JJ.Yda(na.originCell,5,qa);X.state=da.ignore})}MQe(X,R,wa=null,na){return this.rnc.kzj(X,R,wa,this.dNa,na).then(Ba=>
{e.ULS.sendTraceTag(537161887,306,50,`FormulaByExampleManager.EvaluateFormulaAndUpdateModel: model update completed. result: ${Ba.status}.`);switch(Ba.status){case 3:case 1:return 3===Ba.status&&Object(B.h)(X,"Preview shown, but only partially. some cells failed to evaluate."),Promise.resolve(Ba);case 2:return Promise.reject("Calc estimation or model update failed");default:return Promise.reject("Calc estimation failed")}})}G$h(X,R,wa,na,Ba){const Ra=this.OUd;this.Ooj();const qa=wa.suggestion;this.BB&&
Object(B.f)("USERINPUTARRIVED",qa.flowId,na);this.O0d(qa.range,!1);this.JJ.hide();ua.a(()=>{this.BB&&Object(B.f)("PREVIEWREMOVEDWITHCSE",qa.flowId,na);const La={["flowId"]:qa.flowId,["originalFlowId"]:qa.Lca.flowId,["caller"]:R.Oze,["displayTrigger"]:Ba,["formulaAnonymized"]:qa.anonymizedFormula,["originalFormulaAnonymized"]:qa.Lca.anonymizedFormula,["suggestionOutcome"]:R.Lsc,["annotationRange"]:qa.range.toString(),["isFullyInViewport"]:this.gridView.aN(qa.range),["isCachedSuggestion"]:na,["showFormulaClicked"]:Ra,
["exampleCount"]:qa.CJ,["originalExampleCount"]:qa.Lca.CJ,["seenCount"]:wa.hxc,["previewCellsMetadata"]:X.Ksc,["previewShownDurations"]:this.BB?Object(B.e)(na,qa.flowId):"none",["previewRemovedDurations"]:this.BB?Object(B.d)(na,qa.flowId):"none"};e.ULS.sendTraceTag(388780100,306,50,`FormulaByExampleManager.handlePreviewResult: FormulaByExample flow results: ${JSON.stringify(La)}`);Object(B.b)(qa.flowId)},this.$.la);e.ULS.sendTraceTag(523842074,306,50,`FormulaByExampleManager.handlePreviewResult: User ${R.Lsc} the formula via ${R.Oze}`);
wa.state=R.Lsc;wa.bfi();"ACCEPT"===R.Lsc&&this.bZc(qa,X.gad);this.$.userOperationManager.Un(this.bPa)}Ooj(){this.dNa=!1;this.VPa=null;this.OUd=!1}bZc(X,R){const wa=Object(x.a)(new Da.a,{Text:X.formula});this.gridView.setCell(wa,X.originCell,1,127,null,0,X.range,2);this.rnc.zSg(R,X.formula);e.ULS.sendTraceTag(537161883,306,50,`FormulaByExampleManager.applyFormulaSuggestionOnRange: applied formula on table, range: ${X.range}`);this.jEd=(na,Ba)=>{0==Ba.Iq&&(170==Ba.Lf.operation.operationName&&this.mVi(X.flowId,
X.Lca.flowId),this.sVf())};this.$.userOperationManager.Zq(this.jEd)}c9f(X){const R=X.suggestion,wa=this.dni(R.flowId);return wa.value?X.state===da.decline?(this.JJ.Yda(X.suggestion.originCell,6,ka.a.Xqg),e.ULS.sendTraceTag(528758217,306,50,`FormulaByExampleManager.shouldShowPreview: user declined this suggestion before, not showing again. flowId: ${R.flowId}`),{value:!1,reason:"User declined this suggestion before."}):R.CJ<ca.a?(this.JJ.Yda(X.suggestion.originCell,6,ka.a.tqg),e.ULS.sendTraceTag(528758215,
306,50,`FormulaByExampleManager.shouldShowPreview: cached suggestion does not have enough examples. not showing preview. flowId: ${R.flowId}`),{value:!1,reason:"Cached suggestion does not have enough examples."}):!k.EwaSettings.isChangeGateEnabled("OfficeVSO:7161866_FBE_ShowIgnoredSuggestionsIndefinitely")&&X.state===da.ignore&&2<=X.hxc?(this.JJ.Yda(X.suggestion.originCell,6,ka.a.Wqg),e.ULS.sendTraceTag(528758216,306,50,`FormulaByExampleManager.shouldShowPreview: user saw suggestion at least twice and ignored last time. not showing again. flowId: ${R.flowId}`),
{value:!1,reason:"User saw suggestion at least twice and ignored last time"}):k.EwaSettings.isChangeGateEnabled("OfficeVSO:7300192_FBETextCellsUnsupported")&&this.m3e(R.range).some(na=>this.calcManager.Hvi(na.cell.hj))?{value:!1,reason:"At least 1 cell in the loaded suggestion range is formatted as Text"}:k.EwaSettings.isChangeGateEnabled("OfficeVSO:7464540_FBENoneValueTypesUnsupported")&&0===R.$Ke?{value:!1,reason:"suggestion's default value type cannot be none."}:{value:!0}:(this.JJ.Yda(X.suggestion.originCell,
6,ka.a.npg),{value:!1,reason:wa.reason})}O0d(X,R){for(let na=X.top;na<=X.bottom;na++)for(let Ba=X.left;Ba<=X.right;Ba++){var wa=I.Range.Mc(na,Ba);if(wa=this.gridView.Pb(wa))wa.cell.L$f=R&&!wa.cell.Msc}}dni(X){return this.CHd?(e.ULS.sendTraceTag(528758218,306,50,`FormulaByExampleManager.shouldShowPreview: can't show preview again as preview already was shown for the current edit. flowId: ${X}`),{value:!1,reason:"Preview already shown for the latest edit."}):this.dNa?(e.ULS.sendTraceTag(527005664,306,
50,`FormulaByExampleManager.shouldShowPreview: can't show preview for this suggestion as preview is already showing. flowId: ${X}`),{value:!1,reason:"Preview is already showing."}):this.gridView.fb?(e.ULS.sendTraceTag(524813027,306,50,`FormulaByExampleManager.shouldShowPreview: can't show preview for this suggestion as user is editing. flowId: ${X}`),{value:!1,reason:"User is editing."}):{value:!0}}m3e(X){let R=[];const wa=this.gridView.Ca.Cja(X,this.gridView.$.activeItemName);for(const na of wa)R.push(...this.gridView.Bja(X.we(na.De),
na));return R}}Object(r.a)(yb,"FormulaByExampleManager",null,[334,2]);class mb extends t.a{constructor(X){super();this.$=X;this.Db()}create(){e.ULS.sendTraceTag(528758214,0,50,"FormulaByExampleManagerFactory.Create: starting service creation flow.");const X=d.GetServiceTaskFactory.Oa(this.$.da,328,327,1);let R;R=k.EwaSettings.dK()?Object(m.c)(y.a.resolve(u.b,{Tl:1})):d.GetServiceTaskFactory.Oa(this.$.da,266,265,1);const wa=k.EwaSettings.isChangeGateEnabled("OfficeVSO:6327953_FormatOutputResultsOfFBE_V2")?
d.GetServiceTaskFactory.create(this.$.da,18,this.$.la,1):C.Task.Sa(null),na=[X,R,wa];w.init(this.$);h.TaskExtensions.za(h.TaskExtensions.Fd(na,this.la),()=>{e.ULS.sendTraceTag(528758213,0,50,"FormulaByExampleManagerFactory.Create: augmentationLoopManager and calcManager creation tasks resolved.");const Ba=new yb(this.$,X.result,R.result,wa.result,w.instance());this.nb(this.$.da.Aa(453)||this.$.da.Ha(453,Ba));e.ULS.sendTraceTag(537161882,0,50,"FormulaByExampleManagerFactory.Create: FormulaByExampleManager initialized successfully")},
this.la)}static ka(X){X.da.Ha(454,new mb(X))}}Object(r.a)(mb,"FormulaByExampleManagerFactory",t.a,[]);a.d(F,"a",function(){return nb});const nb=()=>{b.a.Fa(X=>{mb.ka(X);v.ka(X)})}},1306:function(r,F,a){r=a(0);var c=a(7),b=a(15),e=a(24),f=a(33),d=a(167),h=a(189),l=a(21),k=a(836),t=a(713);class n extends k.a{constructor(){super();this.formulasCount=this.columnNames=this.additionalInputs=this.examples=null;this.invocationMethod=this.stateID=0;this.guid=this.supportedFunctions=null;this.H_=Object.assign(new t.a,
{T_:n.getTypeName(),B_:n.Kd()})}static getTypeName(){return"AugLoop_FormulaByExample_FormulaByExampleSignal"}static Kd(){return["AugLoop_Signals_Signal"]}}Object(r.a)(n,"FormulaByExampleSignal",k.a,[]);var z=a(1315),w=a(55),m=a(835),u=a(1),y=a(292),v=a(870),C=a(41),x=a(101),B=a(886);a.d(F,"b",function(){return I});a.d(F,"a",function(){return U});const H={TEXTSPLIT:!1,TEXTSLICE:!1,FINDN:!1,TEXTAFTER:!1,TEXTBEFORE:!1},I={O9c:"editRange",Sfb:"triggerCommand",JZd:"triggerKind",SYe:"flowId",yjf:"isInTable"};
class U{constructor(S,G,D,E,N){this.BB=!1;this.$=S;this.gridView=Object(l.h)(S);this.augmentationLoopManager=G;this.calcManager=D;this.formulaByExampleManager=E;this.JJ=N;this.Hk=v.a.getInstance(this.$);this.BB=Object(m.a)(this.$);this.YHi=u.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.FormulaByExampleMaximalNumberOfAdditionalInputRows",30);b.ULS.sendTraceTag(528758226,306,50,"FormulaByExampleCommandHandler.ctor: FBE command handler created")}Hc(){return!1}executeCommand(S,G,D){S=!1;G=G.command;
switch(G){case 1928326585:S=D&&D[I.JZd]?D[I.JZd]:0;const E=D[I.SYe];if(0===S)return b.ULS.sendTraceTag(524940245,306,15,"FormulaByExampleManager.executeCommand: triggerFormulaByExample command called for execution with NoTrigger value."),this.Hk.xo(E,1),w.Task.Sa(!0);const N=!D||!D[I.O9c],M=this.mUh(D,N),L=!D||D[I.yjf];D=!D||D[I.Sfb];N||2!==S||this.formulaByExampleManager.i1i(M,E,L,D);S=this.triggerFormulaByExample(M,N,E,L)}return S?w.Task.Sa(!0):Object(h.a)(G)}wc(S,G){switch(G.command){case 1928326585:return f.a.aic(this.$);
default:return!1}}Nc(){return!1}mUh(S,G){b.ULS.sendTraceTag(537161928,306,50,`FormulaByExampleCommandHandler.getEditedRange: flow triggered from: ${G?"Ribbon":"AutoDetect"}`);return G?this.gridView.ha.qa.activeCell:S[I.O9c]}triggerFormulaByExample(S,G,D,E){if(!this.augmentationLoopManager)return b.ULS.sendTraceTag(537161927,306,10,"FormulaByExampleCommandHandler.TriggerFormulaByExample: augmentationLoopManager instance is null"),this.Hk.xo(D,13,{reason:"AugmentationLoopManager instance is null"}),
!1;let N;if(E){E=this.gridView.tb.Dh(S,!1);if(!E)return b.ULS.sendTraceTag(537161925,306,15,"FormulaByExampleCommandHandler.TriggerFormulaByExample: table returned null for given edit range."),this.Hk.xo(D,13,{reason:"Table returned null for given edit range"}),!1;N=this.VVh(S,G,E,D)}if(!N)return this.Hk.xo(D,13,{reason:"Signal is null"}),!0;b.ULS.sendTraceTag(537161926,306,50,`FormulaByExampleCommandHandler.TriggerFormulaByExample: calling SubmitOperationSignal for flowId: ${D}.`);this.augmentationLoopManager.mOb(N);
this.Hk.xo(D,12);this.JJ.Yda(S,1);this.BB&&Object(m.f)("SIGNALSENT",D);return!0}VVh(S,G,D,E){S=this.oQh(D,S,E);if(!S)return null;D=this.GRh(D);if(!D)return null;G=Object(c.a)(new n,{formulasCount:1,examples:S.examples,additionalInputs:S.additionalInputs,columnNames:D,stateID:this.$.ea.kDb,invocationMethod:G?0:1,guid:E.toString(),supportedFunctions:H});b.ULS.sendTraceTag(528758225,306,50,"FormulaByExampleCommandHandler.getFormulaByExampleSignalFromTable: signal generated.");return G}oQh(S,G,D){S=Object(d.a)(S);
return this.pQh(S,G,D)}GRh(S){const G=[],D=S.name;var E=Object(d.a)(S);S=this.calcManager.byb(S);if(E&&S){E=E.left;for(let N of S)G.push({column:E,name:D+"[@["+N+"]]"}),E++;return G}b.ULS.sendTraceTag(524940244,306,15,`FormulaByExampleCommandHandler.getColumnNamesMapFromTable: failed to generate columnNames. is tableRange null: ${!E}, is colNamesCurrentTable null: ${!S}`);return null}pQh(S,G,D){G=G.left;let E=new Set;u.EwaSettings.isChangeGateEnabled("OfficeVSO:7126337_FBECellCycleFix")&&(E=this.OVh(S,
G,D));return this.Zhh(S,G,E)}OVh(S,G,D){const E=new Set,N=this.gridView.Wj("FormulaByExample.getForbiddenColumnsFromRange",S);try{for(;N.$$mn();){const M=N.$$cu(),L=M.range,aa=L.left;if(aa!==G&&!E.has(aa)){const V=new e.Range(L.top,G,L.top,G,!1,!1);this.$ni(M,V)&&(E.add(aa),this.Hk.Moc(D,aa-(this.$.na.displayRtl?S.right:S.left)))}}}finally{N&&N.dispose()}return E}Zhh(S,G,D){const E=[],N=[],M=S.right,L=new Set;let aa=[],V=!1,P=null;S=this.gridView.Wj("FormulaByExample.createValidExamplesFromRange",
S);try{for(;S.$$mn();){const ba=S.$$cu(),Y=ba.range.left,Z=Y===G;Z&&ba.text?P=this.jHe(ba):Z||D.has(Y)||(ba.text&&(V=!0),aa.push(this.jHe(ba)));Y===M&&(V&&(P?(E.push({output:P,inputs:aa}),L.add(P.rawValueJson)):N.length<this.YHi&&N.push({output:null,inputs:aa})),aa=[],V=!1,P=null)}}finally{S&&S.dispose()}return L.size<B.a?(b.ULS.sendTraceTag(509683013,306,50,"FormulaByExampleCommandHandler.createValidExamplesFromRange: column does not have enough distinct examples with inputs."),null):{examples:E,
additionalInputs:N}}$ni(S,G){const D=S.iS,E=S.range,N=this.$.workbookContext.WorkbookFileName,M=this.$.na;if(!M)return b.ULS.sendTraceTag(509743199,306,50,"FormulaByExampleCommandHandler.isDependingOn: this.ewaControl.activeItem returned null. Expected to be an object of type Sheet."),!1;if(!(u.EwaSettings.isChangeGateEnabled("OfficeVSO:7251463_FBEFixJsCrashOnNullActiveSheet")||M instanceof x.a))return b.ULS.sendTraceTag(509743198,306,50,"FormulaByExampleCommandHandler.isDependingOn: this.ewaControl.activeItem returned object of type other then Sheet. Expected to be an object of type Sheet."),
!1;if(!this.calcManager.Yif(S.cell.hj,D))return!1;if(S=this.calcManager.extractReferences(D,M.name,N,!0,E))for(const L of S.Items)if(Object(C.D)(L.Range).equals(G))return!0;return!1}jHe(S){let G;if(1===S.Gr.type){G=parseFloat(S.Gr.value);var D=this.calcManager.J4a(S.cell.hj);Object(y.c)(D)?D=D.value.isDate?4:D.value.isTime?5:1:(b.ULS.sendTraceTag(522840207,0,10,`FormulaByExampleCommandHandler.createAugLoopCell: CalcManager's getNumberFormat method failed on the given cell, falling back to number format. failureReason: ${D.reason}`),
D=1)}else G=S.text,D=0;return Object.assign(new z.a,{row:S.range.top,column:S.range.left,displayText:S.text,rawValueJson:JSON.stringify(G),numberFormatCategory:D.toString()})}}Object(r.a)(U,"FormulaByExampleCommandHandler",null,[222])},1345:function(r,F,a){a.r(F);a.d(F,"FormulaByExampleAutoSuggestActor",function(){return z});r=a(0);var c=a(15),b=a(24),e=a(167),f=a(94),d=a(21),h=a(835),l=a(1306),k=a(886),t=a(870),n=a(1);class z{constructor(w,m,u){this.BB=!1;this.ROa=(y,v)=>{v.Rrb&&this.gridView.tb.$M(v.Yj)?
(this.qef(v.Yj,324156914),this.Qmi(v.Yj)?this.iDf(v.Yj,v.Yj,324156914):this.SQa()):this.SQa()};this.aEd=(y,v)=>{y=v.destinationRange;if(1804571062===v.command||y.left!==y.right)this.SQa();else{var C=new b.Range(y.top,y.right,y.top,y.right,!1,!1);this.gridView.tb.$M(C)?(this.qef(C,v.command),this.iDf(C,y,v.command)):this.SQa()}};this.Z_i=(y,v)=>{y=this.nlc.Q2g;v=v.Yj.toString();y.has(v)&&(y.delete(v),0===y.size&&this.LMe())};this.$=w;this.gridView=d.h(w);this.calcManager=m;this.BB=u;this.SQa();this.gridView.Vb.Km(this.ROa);
this.calcManager.CMg(this.Z_i);n.EwaSettings.isChangeGateEnabled("OfficeVSO:7395435_FormulaByExampleTriggerOnCSEPaste")&&this.gridView.wre(this.aEd);this.Hk=t.a.getInstance(w)}iDf(w,m,u){this.C5f(w,m,u);-185374993===u&&this.LMe()}qef(w,m){const u=this.gridView.tb.Dh(w,!1);this.Hk.pCf(m,u.name,w.left-(u.displayRtl?u.usedRange.right:u.usedRange.left),w.top-u.usedRange.top)}Qmi(w){var m=this.gridView.Pb(w);if(!m)return c.ULS.sendTraceTag(524120778,306,15,`FormulaByExampleAutoSuggestActor.isCellValidForTriggeringFormulaByExample: formattedCell is null. investigation hints: is cell null = ${!w}`),
this.Hk.xo(t.b,1,{reason:"Didn't trigger since the formattedCell is null."}),!1;w=this.calcManager.Yif(m.cell.hj,m.iS);(m=null!==w&&!w)||this.Hk.xo(t.b,1,{reason:`Didn't trigger since edited cell content is a formula or isFormulaCell returned null. isFormulaText is null:${null==w}`});return m}LMe(){const w=this.O5h(this.nlc.originCell);if(0===w)this.SQa(),this.Hk.xo(t.b,1);else{var m=this.Hk.c5e();this.Hk.xo(m,3);c.ULS.sendTraceTag(537161929,306,50,`FormulaByExampleAutoSuggestActor.tryTriggeringFormulaByExample: triggering FormulaByExample for cell edit. Trigger kind: ${w}, FlowId: ${m}`);
this.BB&&Object(h.f)("EDITCOMMIT",m);var u=new f.a(1928326585,1,2,6,null);this.$.Ia.Hb(u,{[l.b.O9c]:this.nlc.originCell,[l.b.Sfb]:this.nlc.Sfb,[l.b.JZd]:w,[l.b.SYe]:m,[l.b.yjf]:!0});this.SQa()}}O5h(w){return this.gridView.tb.vlf(w)?(this.Hk.xo(t.b,1,{reason:"Didn't trigger since edited cell is a table header"}),0):this.$tj(w)}$tj(w){var m=this.gridView.tb.Dh(w,!1);m=e.a(m);w=w.left;w=new b.Range(m.top,w,m.bottom,w,!0,!0);return this.Ztj(w)}Ztj(w){var m;let u=new Set,y=0;w=this.gridView.Wj("FormulaByExampleAutoSuggestActor:Table",
w);try{for(;w.$$mn();){const v=w.$$cu();if(null===(m=v.Gr)||void 0===m?0:m.value)if(u.add(v.Gr.value),y++,u.size>=k.a)return 2}}finally{w&&w.dispose()}y>=k.a?(c.ULS.sendTraceTag(523368219,306,50,"FormulaByExampleAutoSuggestActor.searchForSufficientExamplesInOutputColumn: Table has sufficient example amount - but not enough distinct examples."),this.Hk.xo(t.b,1,{reason:"Didn't trigger since there aren't enough distinct outputs"})):this.Hk.xo(t.b,1,{reason:"Didn't trigger since there aren't enough examples"});
return 0}SQa(){this.C5f(null,null,null)}C5f(w,m,u){this.nlc={originCell:w,Q2g:new Set(null===m||void 0===m?void 0:m.Ive(m.Oy).map(y=>y.toString())),Sfb:u}}}Object(r.a)(z,"FormulaByExampleAutoSuggestActor",null,[])},1463:function(r,F,a){function c(db){for(const Pa of db.values())for(const ja of Pa.annotations)if(!ja.iz)return!0;return!1}function b(db){return void 0===db?"undefined":`${null===db||void 0===db?void 0:db.Xluid}/${null===db||void 0===db?void 0:db.Xrevid}@${null===db||void 0===db?void 0:
db.DocId}`}a.r(F);r=a(0);var e=a(7),f=a(15),d=a(99);F=a(226);class h{}Object(r.a)(h,"WorkbookCoauthVersion",null,[]);var l=a(38);class k{constructor(){this.stateId=0;this.q1d=null}}Object(r.a)(k,"StateIdChangedInfo",null,[]);var t=a(60);const n=(db,Pa,ja,Ka,ub,Kb,W=null)=>{W=db.Na(1,W);W.isObserverRequired=Pa;return t.g(db,"ObserverRequiredNotification",W,ja,Ka,ub,Kb,0)};class z extends Sys.EventArgs{constructor(db,Pa,ja,Ka){super();this.BG=db;this.parentPath=ja;this.operationType=Ka}}Object(r.a)(z,
"AnnotationReceivedEventArgs",Sys.EventArgs,[]);var w=a(28),m=a(120),u=a(1);class y{constructor(){this.stateUpdateHandler=this.handler=this.config=this.annotationType=null}}Object(r.a)(y,"ActivateAnnotationParameters",null,[]);class v{constructor(){this.supportCustomMessages=this.accessTokenTTL=this.accessToken=this.collabStateId=this.userListVersion=this.configurations=this.permissionFlags=this.serverEventVersion=this.metadataVersion=this.ecsOperationUrl=this.ecsRestUrl=this.ecsSessionId=this.wacCluster=
null}}Object(r.a)(v,"ExcelServerParameters",null,[]);class C{constructor(){this.excelServerParameters=null}}Object(r.a)(C,"ForceReconnectParameters",null,[]);class x{constructor(){this.workflow=null}}Object(r.a)(x,"RegisterLocalWorkflowParameters",null,[]);class B{constructor(){this.handler=null}}Object(r.a)(B,"SetAnnotationResultCallbackParameters",null,[]);class H{constructor(){this.message=null}}Object(r.a)(H,"SubmitCustomMessageParameters",null,[]);class I{constructor(){this.operation=null}}Object(r.a)(I,
"SubmitOperationParameters",null,[]);var U=a(736),S=a(991),G=a(764),D=a(713);class E extends G.a{constructor(){super();this.H_=Object.assign(new D.a,{T_:E.getTypeName(),B_:E.Kd()})}static getTypeName(){return"AugLoop_Core_DeleteOperation"}static Kd(){return["AugLoop_Core_Operation"]}}Object(r.a)(E,"DeleteOperation",G.a,[]);class N extends G.a{constructor(){super();this.isFocused=!1;this.H_=Object.assign(new D.a,{T_:N.getTypeName(),B_:N.Kd()})}static getTypeName(){return"AugLoop_Core_FocusOperation"}static Kd(){return["AugLoop_Core_Operation"]}}
Object(r.a)(N,"FocusOperation",G.a,[]);var M=a(884),L=a(992);class aa extends L.a{constructor(){super();this.prevParentPath=null;this.H_=Object.assign(new D.a,{T_:aa.getTypeName(),B_:aa.Kd()})}static getTypeName(){return"AugLoop_Core_MoveOperation"}static Kd(){return["AugLoop_Core_OperationWithSiblingContext","AugLoop_Core_Operation"]}}Object(r.a)(aa,"MoveOperation",L.a,[]);var V=a(990);class P extends G.a{constructor(){super();this.M_=null;this.H_=Object.assign(new D.a,{T_:P.getTypeName(),B_:P.Kd()})}static getTypeName(){return"AugLoop_Core_UpdateAnnotationMetaDataOperation"}static Kd(){return["AugLoop_Core_Operation"]}}
Object(r.a)(P,"UpdateAnnotationMetaDataOperation",G.a,[]);var ba=a(993);class Y extends G.a{constructor(){super();this.isVisible=!1;this.H_=Object.assign(new D.a,{T_:Y.getTypeName(),B_:Y.Kd()})}static getTypeName(){return"AugLoop_Core_VisibilityOperation"}static Kd(){return["AugLoop_Core_Operation"]}}Object(r.a)(Y,"VisibilityOperation",G.a,[]);var Z=a(730);class ea extends Z.a{constructor(){super();this.bridgeId=this.cv=this.messageId=null;this.H_=Object.assign(new D.a,{T_:ea.getTypeName(),B_:ea.Kd()})}static getTypeName(){return"AugLoop_Session_Protocol_Message"}static Kd(){return[]}}
Object(r.a)(ea,"Message",Z.a,[]);class ra extends ea{constructor(){super();this.activeWorksheetId=null;this.H_=Object.assign(new D.a,{T_:ra.getTypeName(),B_:ra.Kd()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelKeepAlive"}static Kd(){return["AugLoop_Session_Protocol_Message"]}}Object(r.a)(ra,"ExcelKeepAlive",ea,[]);class O extends U.a{constructor(){super();this.isObserverRequired=this.isSeedingRequired=!1;this.H_=Object.assign(new D.a,{T_:O.getTypeName(),B_:O.Kd()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ObserverStatusAnnotation"}static Kd(){return["AugLoop_Core_Annotation"]}}
Object(r.a)(O,"ObserverStatusAnnotation",U.a,[]);class da extends ea{constructor(){super();this.parentPath=this.opType=this.seq=this.item=null;this.H_=Object.assign(new D.a,{T_:da.getTypeName(),B_:da.Kd()})}static getTypeName(){return"AugLoop_Session_Protocol_MicroSyncMessage"}static Kd(){return["AugLoop_Session_Protocol_Message"]}}Object(r.a)(da,"MicroSyncMessage",ea,[]);class xa extends Z.a{constructor(){super();this.id=null;this.sizeBytes=0;this.dataPointer=this.data=null;this.H_=Object.assign(new D.a,
{T_:xa.getTypeName(),B_:xa.Kd()})}static getTypeName(){return"AugLoop_Core_Blob"}static Kd(){return[]}}Object(r.a)(xa,"Blob",Z.a,[]);class ia extends xa{constructor(){super();this.format=0;this.otherFormat=null;this.size=0;this.isOriginalSize=null;this.H_=Object.assign(new D.a,{T_:ia.getTypeName(),B_:ia.Kd()})}static getTypeName(){return"AugLoop_Image_ImageContent"}static Kd(){return["AugLoop_Core_Blob"]}}Object(r.a)(ia,"ImageContent",xa,[]);class Ma extends Z.a{constructor(){super();this.heightPx=
this.widthPx=0;this.H_=Object.assign(new D.a,{T_:Ma.getTypeName(),B_:Ma.Kd()})}static getTypeName(){return"AugLoop_Image_ImageTileMetadata"}static Kd(){return[]}}Object(r.a)(Ma,"ImageTileMetadata",Z.a,[]);class Ta extends Ma{constructor(){super();this.contents=null;this.H_=Object.assign(new D.a,{T_:Ta.getTypeName(),B_:Ta.Kd()})}static getTypeName(){return"AugLoop_Image_ImageTile"}static Kd(){return["AugLoop_Image_ImageTileMetadata"]}}Object(r.a)(Ta,"ImageTile",Ma,[]);var Da=a(100),fa;(function(db){db[db.unknown=
0]="unknown";db[db.fatal=1]="fatal";db[db.tokenExpired=2]="tokenExpired";db[db.modelWorkflowNotSupported=3]="modelWorkflowNotSupported"})(fa||(fa={}));Object(r.b)("ExcelSessionErrorType",fa);class ua{constructor(){this.annotations=[]}Hdb(db){this.LG=db;return this}activateAnnotation(db){if(this.annotations.includes(db))throw db=`Annotation from type ${db.annotationType} was already activated`,f.ULS.sendTraceTag(521216417,0,10,`AugmentationLoopFeatureRegistrationInfoBuilder.activateAnnotation: ${db}`),
Error(db);this.annotations.push(db);return this}Kdb(db){this.featureName=db;return this}build(){if(void 0===this.LG)throw f.ULS.sendTraceTag(521216416,0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: Close callback is not set"),Error("Close callback is not set");if(!u.EwaSettings.isChangeGateEnabled("OfficeVSO:7386847_AddingActivateAnnotationToRegisteredFeatures")&&0===this.annotations.length)throw f.ULS.sendTraceTag(521216415,0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: No annotations were activated"),
Error("No annotations were activated");if(!this.featureName)throw f.ULS.sendTraceTag(521216414,0,10,"AugmentationLoopFeatureRegistrationInfoBuilder.build: Feature Name is not set"),Error("Feature Name is not set");return{featureName:this.featureName,LG:this.LG,annotations:this.annotations}}}Object(r.a)(ua,"AugmentationLoopFeatureRegistrationInfoBuilder",null,[357]);var Fa=a(65),ca;(function(db){db[db.FullyActive=0]="FullyActive";db[db.ClosedAndWaitingOnlyForNonModelRequiredActivation=1]="ClosedAndWaitingOnlyForNonModelRequiredActivation";
db[db.ActiveForNonModelRequired=2]="ActiveForNonModelRequired";db[db.Closed=3]="Closed"})(ca||(ca={}));Object(r.b)("AugmentationLoopServerStatus",ca);class ka extends l.a{constructor(db,Pa,ja,Ka=null){var ub,Kb;super();this.wma=null;this.isObserverRequired=!1;this.Be=null;this.yT=ca.FullyActive;this.okf=!0;this.Uma=new Map;this.BYa=[];this.wne=new Set;this.Eoc=[];this.Doc=new Map;this.DZa=[];this.LDh=new Map([[0,"Unknown"],[1,"Permanent"],[2,"Permanent"],[3,"ModelWorkflowNotSupported"]]);this.P0b=
!1;this.KFc=new h;this.wwa=u.EwaSettings.isChangeGateEnabled("OfficeVSO:7386847_AddingActivateAnnotationToRegisteredFeatures");this.Ogc=u.EwaSettings.isChangeGateEnabled("OfficeVSO:7403069_ALSendActiveWorksheetId");this.Yod=u.EwaSettings.isChangeGateEnabled("OfficeVSO:7550262_AddALResultToALAPI");this.Rc=(W,za)=>{za.oH&&this.$.ea.sessionId&&(f.ULS.sendTraceTag(537170394,0,50,`AugmentationLoopManager.onSessionIdChanged: Update augmentation loop server on new ECS Session ID: '${this.$.ea.sessionId}'`),
this.$L.forceReconnectSession(Object(e.a)(new C,{excelServerParameters:Object(e.a)(new v,{wacCluster:this.$.ya.MachineCluster,ecsSessionId:this.$.ea.sessionId,ecsRestUrl:this.$.ya.RestActionUrl,ecsOperationUrl:"",metadataVersion:0,serverEventVersion:0,permissionFlags:0,configurations:0,userListVersion:0,collabStateId:0,accessToken:this.$.ya.AccessToken,accessTokenTTL:this.$.ya.AccessTokenValidTo.toString()})})).catch(Sa=>{f.ULS.sendTraceTag(526406272,0,50,`AugmentationLoopManager.onSessionIdChanged: forceReconnectSession promise rejected with error ${Sa}`)}),
f.ULS.sendTraceTag(528348225,0,50,`AugmentationLoopManager.onSessionIdChanged: sending ObserverRequiredNotification, isSeedingRequired: ${this.isObserverRequired}`),this.wQd(this.isObserverRequired))};this.Ud=(W,za)=>{W=Object(Fa.p)(za.na)?Object(Fa.d)(za.na):this.activeWorksheetId;za=u.EwaSettings.isChangeGateEnabled("OfficeVSO:7547289_ALCloseALSessionOnInvalidAccessToken")?this.gAe()&&W&&W!==this.activeWorksheetId:W&&W!==this.activeWorksheetId;this.activeWorksheetId=W;za&&(this.G8a=this.uh.Ub,f.ULS.sendTraceTag(520677595,
0,50,`AugmentationLoopManager.onActiveItemChanged: Submitting keepalive custom message. activeSheetId ${this.activeWorksheetId}`),this.R2f())};this.Soc=(W,za,Sa)=>{if(this.wwa){if(this.yT===ca.Closed){f.ULS.shipAssertTag(509682971,0,!1,"AugmentationLoopManager.onCloseMessage: Called while augmentation loop server is closed. Avoiding with early return");return}f.ULS.sendTraceTag(509727633,0,50,`AugmentationLoopManager.onCloseMessage called with shouldRetry: ${W}, errorType: ${fa[za]}, errorCode: ${Sa}`);
if(W)this.BWd();else switch(W=this.PVe(za),this.Kze(W,Sa),this.Q0c(),za){case 3:this.P0b?(this.yT=ca.ActiveForNonModelRequired,this.BWd()):(this.yT=ca.ClosedAndWaitingOnlyForNonModelRequiredActivation,this.hOb());break;case 1:case 0:this.yT=ca.Closed,this.hOb()}}else f.ULS.sendTraceTag(509649305,0,50,`AugmentationLoopManager.onCloseMessage called with shouldRetry: ${W}, errorType: ${fa[za]}, errorCode: ${Sa}`),W?(this.$L.startNewSession(),this.GJd()):(this.BYa.some(Wa=>!Wa.iz)||this.hOb(),za=this.PVe(za),
this.Kze(za,Sa),this.Q0c(),"ModelWorkflowNotSupported"===za&&(this.okf=!1,this.$L.startNewSession(),this.GJd()));u.EwaSettings.isChangeGateEnabled("OfficeVSO:5948479_QuickSavesWhenAloneForAugloop")&&this.$.ea.sessionId&&(f.ULS.sendTraceTag(520679430,0,50,"AugmentationLoopManager.onCloseMessage: sending ObserverRequiredNotification, isSeedingRequired: false"),this.wQd(!1))};this.uc=(W,za)=>{if(za.Bf)f.ULS.sendTraceTag(520677599,0,50,"AugmentationLoopManager.onWorkbookClosing: event triggered due to silent reopen. Avoiding event with early return");
else if(f.ULS.sendTraceTag(537170381,0,50,`AugmentationLoopManager.onWorkbookClosing: handler invoked
      (IsAppBeforeUnload == ${this.$.fMa}, IsAppUnloading == ${this.$.YC}.`),this.$.fMa||this.$.YC)this.hOb(),this.Q0c(),this.$L.closeSession().catch(Sa=>{f.ULS.sendTraceTag(526406240,0,50,`AugmentationLoopManager.onWorkbookClosing: closeSession promise rejected with error ${Sa}`)})};this.vGa=W=>{f.ULS.sendTraceTag(537170380,0,50,"Annotation Received");if(W)if(W.items){var za;({value:za}=this.wma.Fc(Z.a.Hva(W),0));if(0===za)f.ULS.sendTraceTag(537170377,0,10,"AugmentationLoopManager.annotationCallback: Operation Type not supported "+
Z.a.Hva(W));else{var Sa=!0;for(const ab of W.items){if(!ab){f.ULS.sendTraceTag(537170376,0,10,"AugmentationLoopManager.annotationCallback: Error in item");continue}if(!(Z.a.Jyd(W,[E.getTypeName()])||ab.body&&this.Tli(ab.body))){f.ULS.sendTraceTag(537170375,0,10,"AugmentationLoopManager.annotationCallback: Body is either null or not an annotation.");continue}if(u.EwaSettings.isChangeGateEnabled("OfficeVSO:6530013_FilterOutAnnotationsAccordingToOwner")){var Wa=ab.source;if(this.DZa.includes(Wa)){f.ULS.sendTraceTag(520677597,
0,50,`AugmentationLoopManager.annotationCallback: Filtered out annotation of owner ${Wa}`);continue}}Wa=Z.a.Hva(ab.body);if(!Wa){f.ULS.sendTraceTag(523329624,0,50,"AugmentationLoopManager.annotationCallback: annotationType is null");continue}const ma=ab.body;if(!ma){f.ULS.sendTraceTag(523329623,0,50,"AugmentationLoopManager.annotationCallback: annotation is null");continue}const ha=new z(ma,null,W.parentPath,za);Sa=this.vGj(ma)&&Sa;f.ULS.sendTraceTag(576271178,0,50,`AugmentationLoopManager.annotationCallback: Triggering Event handler for Annotation ${Wa}. Should report: ${Sa}. ParentRevId: ${W.parentRevId}`);
this.H1b.Fri(ha.BG.id,W.parentRevId)&&(this.raiseEvent(this.xyd(Wa),ha,this),f.ULS.sendTraceTag(520677596,0,100,`AugmentationLoopManager.annotationCallback: raising newAnnotation event (annotation type: ${Wa})`));this.H1b.fCd(Wa,ha,W.parentRevId);this.raiseEvent(Wa,ha,this)}this.glc&&Sa&&(W=m.a(this.uh,this.glc.q1d),f.ULS.sendTraceTag(590906632,0,50,`AugmentationLoopManager.annotationCallback: Got valid annotation, time elapse from last state id(${this.glc.stateId}): ${W}`))}}else f.ULS.sendTraceTag(537170378,
0,10,"AugmentationLoopManager.annotationCallback: Operation has no items");else f.ULS.sendTraceTag(537170379,0,10,"AugmentationLoopManager.annotationCallback: Operation is null")};this.Dw=(W,za)=>{-1!==za.yxf&&(this.glc=Object(e.a)(new k,{stateId:za.yxf,q1d:this.uh.Ub}))};this.Kca=()=>{const W=m.b(this.uh,this.G8a);if(u.EwaSettings.isChangeGateEnabled("OfficeVSO:7547289_ALCloseALSessionOnInvalidAccessToken"))var za=this.gAe()&&this.Ezd<=W;else{za=this.$.ea.xZ;const Sa=this.$.ea.VW;za=this.Ezd<=W&&
Sa<this.ETa&&!za}za?(this.G8a=this.uh.Ub,f.ULS.sendTraceTag(509682396,0,50,`AugmentationLoopManager.onUserActivityThrottled: Submitting keepalive custom message. secondsSinceLastKeepAlive: ${W}`),this.Ogc?this.R2f():this.$L.submitCustomMessage(Object(e.a)(new H,{message:new ra})).catch(Sa=>{f.ULS.sendTraceTag(509682395,0,50,`AugmentationLoopManager.onUserActivityThrottled: submitCustomMessage promise rejected with error ${Sa}`)})):this.Ezd<=W&&f.ULS.sendTraceTag(520632032,0,50,`AugmentationLoopManager.onUserActivityThrottled: Not submitting keepalive custom message. secondsSinceLastKeepAlive: ${W}`)};
this.OBd=(W,za)=>{W=za.BG;f.ULS.shipAssertTag(537170373,306,!!W,"AugmentationLoopManager.ObserverStatusAnnotationHandler: ObserverStatusAnnotation is null.");f.ULS.sendTraceTag(520677594,0,50,`AugmentationLoopManager.observerStatusAnnotationHandler: received ${JSON.stringify(W)}`);this.isObserverRequired=W.isSeedingRequired&&W.isObserverRequired;this.$.ea.sessionId&&(f.ULS.sendTraceTag(520677593,0,50,`AugmentationLoopManager.observerStatusAnnotationHandler: sending ObserverRequiredNotification, isObserverRequired: ${this.isObserverRequired}`),
this.wQd(this.isObserverRequired))};this.ZQb=(W,za)=>{var Sa;(null===(Sa=null===za||void 0===za?void 0:za.od)||void 0===Sa?0:Sa.WorkbookCoauthVersion)&&this.K1i(za.od.WorkbookCoauthVersion,za.context)};this.uh=Ka||w.a.Ya;this.G8a=this.uh.Ub;this.Ogc&&(this.activeWorksheetId=null!==(ub=Object(Fa.d)(db.na))&&void 0!==ub?ub:this.activeWorksheetId);this.$=db;this.$L=Pa;this.H1b=ja;f.ULS.sendTraceTag(520679433,0,50,`AugmentationLoopManager.constructor: setAnnotationResultCallback ${null===(Kb=this.vGa)||
void 0===Kb?void 0:Kb.name}, activeWorksheetId ${this.activeWorksheetId}`);this.$L.setAnnotationResultCallback(Object(e.a)(new B,{handler:this.vGa}));this.Zhi();this.$.ea.oA(this.Dw);this.$.nj(this.uc);this.glc=Object(e.a)(new k,{stateId:0,q1d:this.uh.Ub});this.$.da.Ha(328,this);this.Ezd=this.$.ya.MinimumSecondsBetweenKeepAlivesFromBrowserToAugloop;this.ETa=60*this.$.ya.UserActiveTimeSinceLastActivityInMinutes;this.$.ea.Jj(this.Rc);this.Ogc&&(this.$.yb.Vf(this.Ud),this.$.va.Vf(this.Ud));this.$.oa.$q(this.ZQb);
u.EwaSettings.isChangeGateEnabled("OfficeVSO:6530013_FilterOutAnnotationsAccordingToOwner")&&this.Hfi();this.wwa?this.hgj():(this.CHg(),this.tHg())}Hfi(){u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableLintBatchLoad",!1)?this.DZa.push("TableLint-Grid-Column"):this.DZa.push("Tablelint-Column");u.EwaSettings.isChangeGateEnabled("OfficeVSO:7001231_IgnoreXlimVNextAnnotations")&&this.DZa.push("ExcelTableRecognitionReducer");u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugmentationLoopTableLint_SecurityClassificationExcelGridPullWorkflow",
!1)&&(u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.FilterOutLegacyLabellingAnnotation",!1)?this.DZa.push("SecurityClassificationExcelGrid"):this.DZa.push("SecurityClassificationExcelGridPull"))}gAe(){const db=this.$.ea.xZ;return 300>this.$.ea.VW&&!db}R2f(){this.$L.submitCustomMessage(Object(e.a)(new H,{message:Object(e.a)(new ra,{activeWorksheetId:this.activeWorksheetId})})).catch(db=>{f.ULS.sendTraceTag(526406239,0,10,`AugmentationLoopManager.sendExcelKeepAliveMessage: submitCustomMessage promise rejected with error ${db}`)})}a4a(){return new ua}bIg(db){db.zV&&
this.PWc(db.annotationType,db.zV);db.Xoa&&this.Vga.g2("Valid",db.annotationType,db.Xoa);db.XLa&&this.Vga.g2("Invalid",db.annotationType,db.XLa)}register(db){if(this.wwa){var Pa=null;let ja;this.Uma.has(db.featureName)?(Pa=`${db.featureName} is already registered. Ignoring new registration.`,ja="AlreadyRegisteredFailure"):this.yT===ca.Closed&&(Pa=`Augmentation loop server is permanently closed. Cannot register ${db.featureName}.`,ja="ServerClosedFailure");if(Pa)return f.ULS.sendTraceTag(509649306,
0,15,`AugmentationLoopManager.register: ${Pa}`),ja;f.ULS.sendTraceTag(509686223,0,50,`AugmentationLoopManager.register: Registering ${db.featureName}`);this.Uma.set(db.featureName,db);db.annotations.forEach(Ka=>this.RTf(db.featureName,Ka))}else{this.Doc.set(db.featureName,db.LG);for(Pa of db.annotations)this.activateAnnotation(Object.assign(Object.assign({},Pa),{featureName:db.featureName})),Pa.zV&&this.PWc(Pa.annotationType,Pa.zV),Pa.Xoa&&this.Vga.g2("Valid",Pa.annotationType,Pa.Xoa),Pa.XLa&&this.Vga.g2("Invalid",
Pa.annotationType,Pa.XLa)}return"Success"}unregister(db){if(this.wwa){const Pa=this.Uma.get(db);if(!Pa)return f.ULS.sendTraceTag(509686220,0,15,`AugmentationLoopManager.unregister: feature ${db} is not registered`),"UnregisteredFeatureFailure";f.ULS.sendTraceTag(509686221,0,50,`AugmentationLoopManager.unregister: unregister ${db}`);Pa.annotations.forEach(ja=>{ja.zV&&this.qVf(ja.annotationType,ja.zV);ja.Xoa&&this.Vga.zQa("Valid",ja.annotationType,ja.Xoa);ja.XLa&&this.Vga.zQa("Invalid",ja.annotationType,
ja.XLa)});this.Uma.delete(db);this.P0b=c(this.Uma)}else this.Doc.delete(db),this.BYa.filter(Pa=>Pa.featureName===db).forEach(Pa=>{Pa.zV&&this.qVf(Pa.annotationType,Pa.zV);Pa.Xoa&&this.Vga.zQa("Valid",Pa.annotationType,Pa.Xoa);Pa.XLa&&this.Vga.zQa("Invalid",Pa.annotationType,Pa.XLa)});return"Success"}voe(db){this.Eoc.push(db);f.ULS.sendTraceTag(520679432,0,50,`AugmentationLoopManager.addCloseCallback: ${null===db||void 0===db?void 0:db.name}`)}PVe(db){var Pa;return null!==(Pa=this.LDh.get(db))&&void 0!==
Pa?Pa:"Unknown"}GJd(){if(this.wwa)switch(this.yT){case ca.FullyActive:this.Uma.forEach(db=>{db.annotations.forEach(Pa=>{this.activateAnnotation(Pa)})});break;case ca.ActiveForNonModelRequired:this.Uma.forEach(db=>{db.annotations.filter(Pa=>!Pa.iz).forEach(Pa=>{this.activateAnnotation(Pa)})});break;case ca.ClosedAndWaitingOnlyForNonModelRequiredActivation:case ca.Closed:f.ULS.shipAssertTag(509661458,0,!1,`AugmentationLoopManager.reactivateAnnotationsBasedOnModelSupported: Called while augmentation loop server is ${ca[this.yT]}`)}else this.okf?
this.BYa.forEach(db=>this.activateAnnotation(db)):this.BYa.filter(db=>!db.iz).forEach(db=>this.activateAnnotation(db))}xyd(db){return`New_${db}ALManager`}PWc(db,Pa){f.ULS.sendTraceTag(520679429,0,50,`AugmentationLoopManager.addNewAnnotationCallback: annotationType: ${db}, handler: ${null===Pa||void 0===Pa?void 0:Pa.name}`);this.addHandler(this.xyd(db),Pa)}qVf(db,Pa){this.wwa&&f.ULS.sendTraceTag(509686219,0,50,`AugmentationLoopManager.removeNewAnnotationCallback: annotationType: ${db}, handler: ${null===
Pa||void 0===Pa?void 0:Pa.name}`);this.removeHandler(this.xyd(db),Pa)}g2(db,Pa){f.ULS.sendTraceTag(520679428,0,50,`AugmentationLoopManager.addAnnotationCallback: annotationType: ${db}, handler: ${null===Pa||void 0===Pa?void 0:Pa.name}`);this.addHandler(db,Pa)}zQa(db,Pa){this.removeHandler(db,Pa)}xoe(db){f.ULS.sendTraceTag(520679427,0,50,"AugmentationLoopManager.addCoauthVersionChangedCallback");this.addHandler("CoauthVersionChangedALManager",db)}RTf(db,Pa){if(this.yT!==ca.FullyActive&&Pa.iz)return f.ULS.sendTraceTag(509650462,
0,50,`AugmentationLoopManager.registerAnnotationInternal: Augmentation loop server does not support model workflow. Cannot activate ${Pa.annotationType}.`),!1;this.P0b||(this.P0b=!Pa.iz);this.SNj(!Pa.iz);this.obg();this.activateAnnotation(Object.assign(Object.assign({},Pa),{featureName:db}));this.bIg(Pa);return!0}Stc(db,Pa){let ja=null,Ka;const ub=this.Uma.get(db);ub?ub.annotations.some(Kb=>Pa.annotationType===Kb.annotationType)?(ja=`Annotation ${Pa.annotationType} is already activated for feature ${db}.`,
Ka="AlreadyRegisteredFailure"):this.yT===ca.Closed&&(ja=`Augmentation loop server is permanently closed. Cannot activate ${Pa.annotationType}.`,Ka="ServerClosedFailure"):(ja=`Feature ${db} is not registered. Cannot activate ${Pa.annotationType}.`,Ka="UnregisteredFeatureFailure");if(ja)return f.ULS.sendTraceTag(509682975,0,15,`AugmentationLoopManager.registerAnnotation: ${ja}`),Ka;f.ULS.sendTraceTag(509686218,0,50,`AugmentationLoopManager.registerAnnotation: Activating annotation ${Pa.annotationType} for feature ${db}.`);
this.RTf(db,Pa)&&ub.annotations.push(Pa);return"Success"}BWd(){f.ULS.sendTraceTag(509661457,0,50,"AugmentationLoopManager.startNewALSession: Starting new AL session.");this.$L.startNewSession();this.obg();this.GJd()}SNj(db){f.ULS.shipAssertTag(509650461,0,this.yT!==ca.Closed,"AugmentationLoopManager.startNewALSessionIfNecessary: Called while augmentation loop server is closed permanently.");this.yT===ca.ClosedAndWaitingOnlyForNonModelRequiredActivation&&db&&(this.yT=ca.ActiveForNonModelRequired,this.BWd())}yYa(db){f.ULS.sendTraceTag(537170390,
0,50,`AugmentationLoopManager.activateAnnotationWithoutRegistration: activating annotation type: ${db}.`);this.wne.has(db)&&f.ULS.sendTraceTag(537170389,0,50,`AugmentationLoopManager.activateAnnotationWithoutRegistration: Annotations ${db} were already activated in client session.`);this.wne.add(db);this.Be||(this.Be=this.$.ea.Be,this.Be.A9(this.Kca));this.$L.activateAnnotation(Object(e.a)(new y,{annotationType:db,stateUpdateHandler:null})).then(Pa=>{Pa||f.ULS.sendTraceTag(537170388,0,10,"AugmentationLoopManager.activateAnnotationWithoutRegistration: ActivateAnnotationsResult is null");
return null}).catch(Pa=>{f.ULS.sendTraceTag(526406243,0,50,`AugmentationLoopManager.activateAnnotationWithoutRegistration: activateAnnotation promise rejected with error ${Pa}`)})}activateAnnotation(db){f.ULS.sendTraceTag(520679425,0,50,`AugmentationLoopManager.activateAnnotation: Activating annotation type: ${db.annotationType}.`);this.wwa||(this.BYa.includes(db)?f.ULS.sendTraceTag(520679424,0,50,`AugmentationLoopManager.activateAnnotation: Annotations ${db.annotationType} were already activated in client session.`):
this.BYa.push(db),this.Be||(this.Be=this.$.ea.Be,this.Be.A9(this.Kca)));u.EwaSettings.isChangeGateEnabled("OfficeVSO:6044361_XLALCatchPromiseFailures")?this.$L.activateAnnotation(Object(e.a)(new y,{annotationType:db.annotationType,stateUpdateHandler:db.ute})).then(Pa=>{Pa||f.ULS.sendTraceTag(520677603,0,10,"AugmentationLoopManager.activateAnnotation: ActivateAnnotationsResult is null");return null}).catch(Pa=>{f.ULS.sendTraceTag(520677602,0,50,`AugmentationLoopManager.activateAnnotation: activateAnnotation promise rejected with error ${Pa}`)}):
this.$L.activateAnnotation(Object(e.a)(new y,{annotationType:db.annotationType,stateUpdateHandler:db.ute})).then(Pa=>{Pa||f.ULS.sendTraceTag(520677601,0,10,"AugmentationLoopManager.activateAnnotation: ActivateAnnotationsResult is null");return null})}submitOperation(db){if(this.Yod){if(!db)return f.ULS.shipAssertTag(537170387,0,!1,"AugmentationLoopManager.submitOperation: operation is null"),"InvalidParameterFailure"}else f.ULS.shipAssertTag(537170387,0,!!db,"AugmentationLoopManager.submitOperation: operation is null");
f.ULS.sendTraceTag(537170386,0,50,`AugmentationLoopManager.submitOperation: submitting operation of type '${Z.a.Hva(db)}'`);this.$L.submitOperation(Object(e.a)(new I,{operation:db}));return"Success"}mOb(db){if(this.Yod){if(!db){f.ULS.shipAssertTag(537170385,0,!1,"AugmentationLoopManager.submitOperationSignal: signal is null");return}}else f.ULS.shipAssertTag(537170385,0,!!db,"AugmentationLoopManager.submitOperationSignal: signal is null");const Pa=Object.getTypeName(db);f.ULS.sendTraceTag(537170384,
0,50,`AugmentationLoopManager.submitOperationSignal: submitting operation signal of type '${Pa}'`);this.$L.submitOperation(Object(e.a)(new I,{operation:Object(e.a)(new V.a,{parentPath:["Signal",Object.getTypeName(db)],items:[Object(e.a)(new M.a,{body:db})]})}))}registerLocalWorkflow(db){if(this.Yod){if(!db)return f.ULS.shipAssertTag(537170383,0,!1,"AugmentationLoopManager.registerLocalWorkflow: workflow is null"),"InvalidParameterFailure"}else f.ULS.shipAssertTag(537170383,0,!!db,"AugmentationLoopManager.registerLocalWorkflow: workflow is null");
f.ULS.sendTraceTag(537170382,0,50,`AugmentationLoopManager.registerLocalWorkflow: registering local workflow '${db.id}'`);this.$L.registerLocalWorkflow(Object(e.a)(new x,{workflow:db}));return"Success"}X2j(db,Pa,ja,Ka){db=Object(e.a)(new Ta,{heightPx:Ka,widthPx:ja,contents:[Object(e.a)(new ia,{id:Pa+".0",format:2,size:3,sizeBytes:db.length,data:db})]});Pa=Object(e.a)(new M.a,{id:Pa,body:db});Pa=Object(e.a)(new da,{item:Pa});f.ULS.sendTraceTag(520677600,0,50,"AugmentationLoopManager.uploadImage: submitting custom message");
this.$L.submitCustomMessage(Object(e.a)(new H,{message:Pa})).catch(ub=>{f.ULS.sendTraceTag(526406241,0,50,`AugmentationLoopManager.uploadImage: submitCustomMessage promise rejected with error ${ub}`);return"UnknownFailure"})}get Vga(){return this.H1b}dispose(){this.$&&this.$.ea&&this.$.ea.ik(this.Rc);this.$&&this.$.yb&&this.Ogc&&(this.$.yb.sg(this.Ud),this.$.va.sg(this.Ud));this.$&&this.$.oa&&this.$.oa.ps(this.ZQb);this.Eoc=[];this.Doc.clear();this.hOb();super.dispose()}obg(){this.Be||(this.Be=this.$.ea.Be,
this.Be.A9(this.Kca));this.$.ea.oA(this.Dw)}hOb(){this.Be&&(this.Be.Yza(this.Kca),this.Be=null);this.$.ea.uB(this.Dw)}Q0c(){for(let db of this.Eoc)try{db()}catch(Pa){f.ULS.sendTraceTag(528016151,0,10,`AugmentationLoopManager.callAndClearAugloopCloseCallbacks: caught exception with message: ${Pa.message}`)}this.Eoc=[]}Kze(db,Pa){if(this.wwa)for(const ja of this.Uma.values()){if(this.yT===ca.FullyActive||!ja.annotations.every(Ka=>Ka.iz))try{ja.LG(db,Pa)}catch(Ka){f.ULS.sendTraceTag(509674971,0,10,`AugmentationLoopManager.callAugloopCloseCallbacks: caught exception from ${ja.featureName} close callback with message: ${Ka.message}`)}}else for(const ja of this.Doc.values())try{ja(db,
Pa)}catch(Ka){f.ULS.sendTraceTag(509686216,0,10,String.format(`AugmentationLoopManager.callAugloopCloseCallbacks: caught exception with message: ${Ka.message}`))}}Zhi(){this.wma=new Da.a;this.wma.ia(S.a.getTypeName(),1);this.wma.ia(ba.a.getTypeName(),2);this.wma.ia(aa.getTypeName(),5);this.wma.ia(E.getTypeName(),3);this.wma.ia(Y.getTypeName(),7);this.wma.ia(N.getTypeName(),6);this.wma.ia(P.getTypeName(),4)}Tli(db){return Z.a.Hva(db)===U.a.getTypeName()||0<=Array.indexOf(Z.a.F0e(db),U.a.getTypeName())}vGj(db){if(db){if(u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.SharedOnline.AutoCLPV2Transition",
!1)){var Pa=!!db.recommended&&!!db.recommended.id;return!!db.automatic&&!!db.automatic.id||Pa}Pa=!!db.recommended&&!!db.recommended.sensitivityLabel&&!!db.recommended.sensitivityLabel.id;return!!db.automatic&&!!db.automatic.sensitivityLabel&&!!db.automatic.sensitivityLabel.id||Pa}return!1}hgj(){this.register(this.a4a().Kdb("ALManagerInternalAnnotations").Hdb(()=>{}).activateAnnotation({annotationType:O.getTypeName(),iz:!1,zV:this.OBd}).build());u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UnitTelemetryAL",
!1)&&this.Stc("ALManagerInternalAnnotations",{annotationType:"AugLoop_UnitTelemetry_UnitTelemetryAggregatedAnnotation",iz:!0});u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TablelintComparison",!1)&&this.Stc("ALManagerInternalAnnotations",{annotationType:"AugLoop_Excel_ExcelComparisonAnnotation",iz:!0})}tHg(){u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UnitTelemetryAL",!1)&&this.activateAnnotation({annotationType:"AugLoop_UnitTelemetry_UnitTelemetryAggregatedAnnotation",
iz:!0});u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TablelintComparison",!1)&&this.activateAnnotation({annotationType:"AugLoop_Excel_ExcelComparisonAnnotation",iz:!0})}CHg(){this.activateAnnotation({annotationType:O.getTypeName(),iz:!0,zV:this.OBd});this.PWc(O.getTypeName(),this.OBd)}wQd(db){n(this.$.oa.xa,db,null,null,null,null)}K1i(db,Pa){if(this.KFc.DocId!==db.DocId||this.KFc.Xluid!==db.Xluid&&this.KFc.Xrevid!==db.Xrevid)this.KFc=db,this.raiseEvent("CoauthVersionChangedALManager",
{coauthVersion:db,userContext:Pa},this),this.H1b.J1i(db,Pa.userContext)}}Object(r.a)(ka,"AugmentationLoopManager",l.a,[335,2]);var Ca=a(4),fb=a(389),yb=a(201),mb=a(151),nb=a(30),X=a(84),R=a(51);class wa{constructor(){this.syncDeltaTimeout=this.disableSyncDeltaSending=this.isDeltaGeneratorEnabled=this.powerpoint=this.downloadPolymerBaseUrl=this.inferenceServiceVersion=this.downloadBaseUrl=this.sessionCreationOptions=this.disabledServiceGroups=this.privateMode=this.flights=this.excelServer=this.initSession=
this.sessionId=this.releaseFork=this.releaseCustomAudience=this.releaseChannel=this.releaseAudienceGroup=this.uiLanguage=this.appVersion=this.appName=this.serviceUrl=null}}Object(r.a)(wa,"InitializeParameters",null,[]);class na{constructor(){this.enableRemoteExecutionNotification=this.networkMode=this.egress=this.localRegisteredWorkflows=this.enableComplexLocalWorkflows=this.serviceUrl=this.onServerAuthenticationStateChangeCallback=this.onSessionClose=this.onSessionReconnect=this.onSessionDisconnect=
this.onSessionConnect=this.flights=this.extensionConfigs=this.docSessionId=null}}Object(r.a)(na,"SessionCreationOptions",null,[]);class Ba{constructor(){this.featureEnabledCallback=null}}Object(r.a)(Ba,"SetIsFeatureEnabledCallbackParameters",null,[]);class Ra{constructor(){this.requestAuthTokenCallback=null}}Object(r.a)(Ra,"SetRequestAuthTokenCallbackParameters",null,[]);class qa{constructor(){this.sendOTelEvent=null}}Object(r.a)(qa,"SetSendOTelEventCallbackParameters",null,[]);class La{constructor(){this.handler=
null}}Object(r.a)(La,"SetSessionInitOverrideCallbackParameters",null,[]);class Yb{constructor(){this.ulsLogger=null}}Object(r.a)(Yb,"SetULSLoggerParameters",null,[]);class mc extends Z.a{constructor(){super();this.activeWorksheetId=this.supportCustomMessages=this.accessTokenTTL=this.accessToken=this.collabStateId=this.collabUserListVersion=this.configurations=this.permissionFlags=this.serverEventVersion=this.workbookMetadataVersion=this.ecsOperationUrl=this.restUrl=this.ecsId=this.cluster=null;this.H_=
Object.assign(new D.a,{T_:mc.getTypeName(),B_:mc.Kd()})}static getTypeName(){return"AugLoop_Excel_Session_Protocol_ExcelServerSessionExtensionConfig"}static Kd(){return[]}}Object(r.a)(mc,"ExcelServerSessionExtensionConfig",Z.a,[]);var Zb=a(882),qb=a(204);class Ha{static vAi(db,Pa,ja){if(Ha.G1b)return f.ULS.sendTraceTag(537170369,0,15,"augloop: LoadAndInitializeAugLoopRuntimeManager called more than once"),Ha.G1b;const Ka=Ca.AFrameworkApplication.fa.Wa("AugLoopCloudALServiceUrl");if(!Ka||!Ka.length)return f.ULS.sendTraceTag(537170368,
0,15,"AugmentationLoopRuntimeProxy.LoadAndInitializeAugLoopRuntimeManager: AugLoopCloudALServiceUrl is null or empty"),Promise.reject(null);ja=qb.a(R.a.loadScript(83,4,ja,void 0,void 0,327));Ha.G1b=ja.then(()=>{const ub=augLoop.ALFactoryGlobal.getAugLoopRuntimeManager();Ha.Rgi(db,Pa,ub);return Promise.resolve(ub)}).catch(ub=>{f.ULS.sendTraceTag(537170339,0,10,"augloop: Failed to download script:"+ub);return Promise.reject(null)});return Ha.G1b}static Rgi(db,Pa,ja){var Ka;f.ULS.sendTraceTag(537170338,
0,50,"augloop: Successfully loaded script");Ha.uh||Ha.Lxj(w.a.Ya);Ha.Cqd=new Set;f.ULS.sendTraceTag(522803219,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: setIsFeatureEnabledCallback");ja.setIsFeatureEnabledCallback(Object(e.a)(new Ba,{featureEnabledCallback:Kb=>{const W=Ca.AFrameworkApplication.fa.pa("AugLoop"+Kb),za=u.EwaSettings.getBooleanFeatureGate(Kb,!1),Sa=u.EwaSettings.getBooleanFeatureGate("AugLoop"+Kb,!1),Wa=za||Sa,ab=W||Wa;Ha.Cqd.has(Kb)||(Ha.Cqd.add(Kb),f.ULS.shipAssertTag(537170337,
0,!(W&&!Wa),`AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager.isFeatureEnabled: legacy app setting return true for feature ${Kb}, but feature gate return false. This is problem because app setting is depricated and about to be removed`),ab&&f.ULS.sendTraceTag(537170336,0,50,`AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager.isFeatureEnabled: feature ${Kb} is enabled. legacyAppSettingResult: ${W}, featureGateWithoutPrefix: ${za}, featureGateWithPrefix: ${Sa}`));return ab}}));
if(u.EwaSettings.ra(379))if(Pa){var ub=Ha.zbc(Pa);ub=Ha.zbc(Pa,Ca.AFrameworkApplication.fa.Wa("AugloopACLPUserDataSignature"));f.ULS.sendTraceTag(522803218,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: Callback is passed to the augloop runtime which calls the code  when an auth token is required");ja.setRequestAuthTokenCallback(Object(e.a)(new Ra,{requestAuthTokenCallback:ub}))}else f.ULS.sendTraceTag(537170335,0,10,"Oauth manager is null");f.ULS.sendTraceTag(522803217,0,50,
"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setULSLogger");ja.setULSLogger(Object(e.a)(new Yb,{ulsLogger:new fb.a}));f.ULS.sendTraceTag(522803216,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setSendOTelEventCallback");ja.setSendOTelEventCallback(Object(e.a)(new qa,{sendOTelEvent:Ha.sendOTelEvent}));Pa=new Map;ub=u.EwaSettings.QUh();for(const [Kb,W]of ub)Pa.set(Kb,String(W));u.EwaSettings.ra(381)&&Pa.set("AugmentationLoopObserverSession",
void 0);u.EwaSettings.ra(422)&&Pa.set("AugmentationLoopIncrementalUpdates",void 0);u.EwaSettings.ra(387)&&Pa.set("EnterpriseDataTypeMipSupport",void 0);(u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.ExcelOnline.TableLintExperiment",!1)||u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.ExcelOnline.TableLintProdExperiment",!1)||u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligence",!1)||u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UnitTelemetryAL",
!1))&&Pa.set("LoadAdditionalDataToModel",void 0);u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.DataCleansingTaskPane",!1)&&(Pa.set("DataCleansingSlice0",void 0),Pa.set("LoadAdditionalDataToModel",void 0));u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugloopNoLatency",!1)&&Pa.set("AugloopNoLatency",void 0);u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableLintInvestigationTelemetry",!1)&&Pa.set("TableLintInvestigationTelemetry",void 0);u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TelemetryWorkflowIncludeTextHints",
!1)&&Pa.set("TelemetryWorkflowIncludeTextHints",void 0);u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.Insights.UseTableRecoMLTableIntelligence",!1)&&Pa.set("UseTableRecoMLTableIntelligence",void 0);u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligenceLogging",!1)&&Pa.set("TableIntelligenceLogging",void 0);u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.AugloopWaitForWorkbookChangeState",!1)&&Pa.set("AugloopWaitForWorkbookChangeState",void 0);u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.XLALReadMetadataFromUserEcsSession",
!1)&&Pa.set("XLALReadMetadataFromUserEcsSession",void 0);u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.XLALWorksheetScopingEnable",!1)&&Pa.set("XLALWorksheetScopingEnable",void 0);u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.UseTableSenseML",!1)&&Pa.set("UseTableSenseML",void 0);u.EwaSettings.getBooleanFeatureGate("Microsoft.Office.Excel.TableIntelligenceSheetCountThreshold",!1)&&(null===(Ka=null===db||void 0===db?void 0:db.va)||void 0===Ka?0:Ka.count)&&db.va.count>u.EwaSettings.getIntFeatureGate("Microsoft.Office.Excel.TableIntelligenceSheetCountThresholdValue",
100)&&(Pa.set("TableIntelligenceSheetCountThreshold",void 0),f.ULS.sendTraceTag(521151777,306,50,`TableIntelligence max sheet count exceeded. SheetCount: ${db.va.count}`));Ka=u.EwaSettings.KTh();for(const Kb of Ka)Pa.set(Kb,"false");f.ULS.sendTraceTag(522803215,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setInitSessionCallback");ja.setInitSessionCallback({initSessionCallback:()=>{var Kb;if(null===(Kb=null===db||void 0===db?void 0:db.ea)||void 0===Kb?0:Kb.sessionId)return f.ULS.sendTraceTag(527708568,
0,50,`AugmentationLoopRuntimeProxy.setInitSessionCallback: initSessionCallback called, sessionId is valid (length = ${db.ea.sessionId.length}), return resolved promise`),Promise.resolve();f.ULS.sendTraceTag(527708567,0,50,"AugmentationLoopRuntimeProxy.setInitSessionCallback: initSessionCallback called, sessionId is not valid, return promise that will be resolved when session id will be valid again.");return new Promise(W=>{var za;const Sa=()=>{var Wa;(null===(Wa=null===db||void 0===db?void 0:db.ea)||
void 0===Wa?0:Wa.sessionId)?(f.ULS.sendTraceTag(527708566,0,50,`AugmentationLoopRuntimeProxy.setInitSessionCallback: sessionId changed callback called with valid session id (length = ${db.ea.sessionId.length}), resolve the promise and unregister the callback.`),db.ea.ik(Sa),W()):f.ULS.sendTraceTag(527708565,0,50,"AugmentationLoopRuntimeProxy.setInitSessionCallback: sessionId changed callback called, but the session id is not valid yet, keep waiting.")};null===(za=null===db||void 0===db?void 0:db.ea)||
void 0===za?void 0:za.Jj(Sa)})}});f.ULS.sendTraceTag(522803214,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.setSessionInitOverrideCallback");ja.setSessionInitOverrideCallback(Object(e.a)(new La,{handler:Kb=>{var W;Kb.extensionConfigs=[Object(e.a)(new mc,{cluster:db.ya.MachineCluster,ecsId:Ha.iUh(db),restUrl:db.ya.RestActionUrl,ecsOperationUrl:"",workbookMetadataVersion:0,serverEventVersion:0,permissionFlags:0,configurations:0,collabUserListVersion:0,collabStateId:0,
accessToken:db.ya.AccessToken,accessTokenTTL:db.ya.AccessTokenValidTo.toString(),activeWorksheetId:u.EwaSettings.isChangeGateEnabled("OfficeVSO:7403069_ALSendActiveWorksheetId")?null!==(W=Object(Fa.d)(db.na))&&void 0!==W?W:void 0:void 0})];u.EwaSettings.isChangeGateEnabled("OfficeVSO:7403069_ALSendActiveWorksheetId")?f.ULS.sendTraceTag(509682397,0,50,`AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: access token TTL ${db.ya.AccessTokenValidTo.toString()}, activeWorksheetId ${Object(Fa.d)(db.na)}`):
f.ULS.sendTraceTag(537170334,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: access token TTL "+db.ya.AccessTokenValidTo.toString());return Kb}}));f.ULS.sendTraceTag(522803213,0,50,"AugmentationLoopRuntimeProxy.InitializeAugLoopRuntimeManager: runtimeManager.initialize - onSessionClose: getOnCloseMessageCallback ");ja.initialize(Object(e.a)(new wa,{serviceUrl:Ca.AFrameworkApplication.fa.Wa("AugLoopCloudALServiceUrl"),appName:"Excel",appVersion:Ca.AFrameworkApplication.fa.Wa("BuildVersion")||
"",releaseAudienceGroup:Ca.AFrameworkApplication.Rb?Object(X.a)(String,Ca.AFrameworkApplication.Rb.AudienceGroup)||"":"",releaseChannel:null,releaseFork:null,sessionId:db.ya.UserSessionId,initSession:!0,flights:this.B$g(Pa),uiLanguage:Ca.AFrameworkApplication.uiCulture,excelServer:null,sessionCreationOptions:Object(e.a)(new na,{onSessionClose:Ha.g_h()})}))}static B$g(db){return Array.from(db.entries()).map(([Pa,ja])=>void 0!==ja?`${Pa}:${ja}`:Pa).map(Pa=>Pa+";").join("")}static g_h(){return db=>{let Pa=
!yb.a.instance.SQ(Ca.AFrameworkApplication.qk);const ja=null===db||void 0===db?void 0:db.reason;Pa?db?db.reason&&(u.EwaSettings.isChangeGateEnabled("OfficeVSO:7476139_deprecateIsRetryable")?f.ULS.shipAssertTag(509658147,0,!(void 0===ja.errorType||null===ja.errorType),"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: closeReason.errorType is null"):f.ULS.shipAssertTag(509682979,0,!(void 0===ja.isRetryableError||null===ja.isRetryableError),"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: closeReason.isRetryableError is null"),
Pa&&(Pa=null==ja.errorType||2===ja.errorType)):f.ULS.shipAssertTag(537170331,0,!1,"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: - closeMessage is null"):f.ULS.sendTraceTag(537170330,0,15,"AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: access token has expired");f.ULS.sendTraceTag(509727632,0,50,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: is called with shouldRetry: ${Pa},
        errorType: ${fa[null===ja||void 0===ja?void 0:ja.errorType]},
        errorCode: ${null===ja||void 0===ja?void 0:ja.errorCode},
        isExpected: ${null===ja||void 0===ja?void 0:ja.isExpected}`);Pa&&((!Ha.dPb||m.a(Ha.uh,Ha.dPb)>Ha.PSf)&&Ha.Voj(),Ha.Gtc<Ha.Ryd?(Ha.Gtc++,f.ULS.sendTraceTag(537170328,0,50,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: Start new session attempt ${Ha.Gtc} of ${Ha.Ryd}. Time of first attempt in this interval of reconnects: ${Ha.dPb}`)):(f.ULS.sendTraceTag(537170327,0,15,`AugmentationLoopRuntimeProxy.GetOnCloseMessageCallback: Reached the limit of ${Ha.Ryd} attempts for session creation under interval of ${Ha.PSf} Ms. Stop trying to reconnect. Time of first attempt in this iterval: ${Ha.dPb}.`),
Pa=!1));Ha.WAf(Pa,null===ja||void 0===ja?void 0:ja.errorType,null===ja||void 0===ja?void 0:ja.errorCode)}}static Nxj(db){Ha.WAf=db}static Lxj(db){Ha.uh=db}static Voj(){Ha.Gtc=0;Ha.dPb=Ha.uh.Ub}static zbc(db,Pa=""){return()=>{try{return f.ULS.sendTraceTag(527970953,0,50,`AugmentationLoopRuntimeProxy.getAuthTokenDelegate: called with fallbackValue.length: ${Pa.length}.`),db.AO("AugLoop",Ca.AFrameworkApplication.fa.Wa("AugLoopOAuthResourceUriV2")).then(ja=>{if(ja.IsSuccess)return f.ULS.sendTraceTag(527970952,
0,50,"AugmentationLoopRuntimeProxy.getAuthTokenDelegate: successfully fetch token."),ja.Token;f.ULS.sendTraceTag(537170326,0,15,`AugmentationLoopRuntimeProxy.getAuthTokenDelegate: failed to get token, use fallback value (length: ${Pa.length})`);return Pa},()=>{f.ULS.sendTraceTag(537170325,0,15,"AugmentationLoopRuntimeProxy.getAuthTokenDelegate: got rejected promise, use fallback value");return Pa})}catch(ja){return f.ULS.sendTraceTag(537170324,0,10,"Exception thrown when fetching token"),Promise.resolve(Pa)}}}static sendOTelEvent(db){mb.a.sendOtelEvent(Object(e.a)(new Zb.a,
{otelEvent:db}))}static iUh(db){const Pa=nb.a.hf(db.ea.sessionId);db=`cluster=${db.ya.MachineCluster}&session=${Pa}&usid=${db.ya.UserSessionId}`;u.EwaSettings.isChangeGateEnabled("OfficeVSO:5897059_XLALInvestigateIncorrectSessionId")&&f.ULS.sendTraceTag(528348230,0,50,`AugmentationLoopRuntimeProxy.getEcsSessionId: ecsSessionId length is ${db.length}`);return db}}Ha.Ryd=3;Ha.PSf=3E5;Ha.Gtc=0;Ha.dPb=null;Ha.uh=null;Ha.G1b=null;Ha.WAf=null;Ha.Cqd=null;Object(r.a)(Ha,"AugmentationLoopRuntimeProxy",null,
[]);var Ya=a(50),Gb=a(37),Ja=a(194),Na;(function(db){db.newAnnotation="New";db.validAnnotation="Valid";db.invalidAnnotation="Invalid"})(Na||(Na={}));Object(r.b)("AnnotationCallbackType",Na);var Qa;(function(db){db.newAnnotation="New";db.validOnArrivalAnnotation="ValidOnArrival";db.validAfterSomeTimeAnnotation="ValidAfterSomeTime";db.invalidOnCoauthVersionChangedAnnotation="InvalidOnCoauthVersionChanged";db.invalidAfterTimeoutAnnotation="InvalidAfterTimeout"})(Qa||(Qa={}));Object(r.b)("AnnotationEventType",
Qa);var Oa;(function(db){db[db.beforeAnnotation=0]="beforeAnnotation";db[db.atAnnotation=1]="atAnnotation";db[db.afterAnnotation=2]="afterAnnotation"})(Oa||(Oa={}));Object(r.b)("TimelinePosition",Oa);class bb{constructor(){this.zfb=new Map;f.ULS.sendTraceTag(520176320,0,50,"AugmentationLoopAnnotationValidatorLogger.constructor: called")}moe(db){this.zfb.has(db)||(f.ULS.sendTraceTag(520176291,0,50,`AugmentationLoopAnnotationValidatorLogger.addAnnotationType: ${db}`),this.zfb.set(db,[]))}Khj(db){this.zfb.delete(db)&&
f.ULS.sendTraceTag(520176290,0,50,`AugmentationLoopAnnotationValidatorLogger.removeAnnotationType: ${db}`)}dXi(db,Pa){db.find(ja=>ja.annotationId===Pa)||db.push({annotationId:Pa,mTj:Date.now(),M0b:Qa.newAnnotation})}eDi(db,Pa,ja,Ka){f.ULS.sendTraceTag(520176289,0,50,`AugmentationLoopAnnotationValidatorLogger.logLatencyEntry: type: ${db}, entry: (${Pa.annotationId} ${Pa.M0b}) incoming: ${Ka}, latency: ${ja-Pa.mTj} ms`)}Pbi(db,Pa,ja){return(ja===Qa.validAfterSomeTimeAnnotation||ja===Qa.validOnArrivalAnnotation)&&
(db.annotationId===Pa||db.M0b===Qa.invalidAfterTimeoutAnnotation)}T0i(db,Pa,ja,Ka){let ub=[];const Kb=Date.now();let W=Oa.beforeAnnotation;for(let za of Pa){this.Pbi(za,ja,Ka)&&this.eDi(db,za,Kb,Ka);if(za.annotationId===ja){za.M0b=Ka;if(Ka===Qa.invalidAfterTimeoutAnnotation)return;W=Oa.atAnnotation}else W===Oa.atAnnotation&&(W=Oa.afterAnnotation);Pa=Ka===Qa.invalidOnCoauthVersionChangedAnnotation?za.annotationId!==ja:za.M0b===Qa.newAnnotation;const Sa=W===Oa.afterAnnotation;(W!==Oa.afterAnnotation&&
Pa||Sa)&&ub.push(za)}this.zfb.set(db,ub)}eOi(db,Pa,ja){let Ka=this.zfb.get(db);Ka||(this.moe(db),Ka=this.zfb.get(db));ja===Qa.newAnnotation?this.dXi(Ka,Pa):this.T0i(db,Ka,Pa,ja)}}Object(r.a)(bb,"AugmentationLoopAnnotationValidatorLogger",null,[]);class Ga{constructor(db,Pa){this.toString=()=>JSON.stringify(this);this.annotationId=db;this.coauthVersion=Pa}}Object(r.a)(Ga,"LocalAnnotationId",null,[]);class tb extends l.a{constructor(db=36E5){super();this.vNa=new Map;this.b_=new Map;this.VOa=new Set;
this.H1d=new bb;this.CWe=db;f.ULS.sendTraceTag(523337872,0,50,`AugmentationLoopAnnotationValidator.constructor: annotationExpirationTimeout: ${this.CWe} ms`)}dispose(){f.ULS.sendTraceTag(523337871,0,50,`AugmentationLoopAnnotationValidator.dispose: ${this.getStatus()}`);this.VOa.clear();this.b_.clear();this.vNa.clear();super.dispose()}xoe(db){f.ULS.sendTraceTag(521405910,0,50,"AugmentationLoopAnnotationValidator.addCoauthVersionChangedCallback");this.addHandler("CoauthVersionChanged",db)}g2(db,Pa,
ja){f.ULS.sendTraceTag(521405908,0,50,`AugmentationLoopAnnotationValidator.addAnnotationCallback: annotationType: ${Pa}`);this.addHandler(this.vyd(db,Pa),ja);u.EwaSettings.isChangeGateEnabled("OfficeVSO:6807759_AugmentationLoopAnnotationValidatorLoggerEnabled")&&this.H1d.moe(Pa)}zQa(db,Pa,ja){f.ULS.sendTraceTag(521405907,0,50,`AugmentationLoopAnnotationValidator.removeAnnotationCallback: annotationType: ${Pa}`);this.removeHandler(this.vyd(db,Pa),ja);u.EwaSettings.isChangeGateEnabled("OfficeVSO:6807759_AugmentationLoopAnnotationValidatorLoggerEnabled")&&
this.H1d.Khj(Pa)}J1i(db,Pa){f.ULS.sendTraceTag(523337870,0,50,`AugmentationLoopAnnotationValidator.onWorkbookCoauthVersionUpdate: starting, raising CoauthVersionChanged event: ${b(db)}`);this.raiseEvent("CoauthVersionChanged",{coauthVersion:db,userContext:Pa},this);this.Aki(this.S6b);this.S6b=db;this.K4j(this.S6b);this.Wff();f.ULS.sendTraceTag(523337869,0,50,`AugmentationLoopAnnotationValidator.onWorkbookCoauthVersionUpdate: done ${this.getStatus()}`)}OWe(db){if(db)try{const ub=JSON.parse(db);var Pa=
ub.coauthVersionDocId,ja=ub.coauthVersionXluid,Ka=ub.coauthVersionXrevId;return{DocId:"undefined"===Pa?void 0:Pa,Xluid:"undefined"===ja?void 0:ja,Xrevid:"undefined"===Ka?void 0:parseInt(Ka,10)}}catch(ub){f.ULS.sendTraceTag(523337868,0,10,`AugmentationLoopAnnotationValidator.extractWorkbookCoauthVersion(${db}): Exception - ${ub}`)}}fCd(db,Pa,ja){ja=this.OWe(ja);void 0!==ja&&(f.ULS.sendTraceTag(523337867,0,50,`AugmentationLoopAnnotationValidator.onAnnotationReceived: starting ${db}: ${Pa.operationType}: (annotation id ${Pa.BG.id}) at ${b(ja)}`),
this.NJg({annotationType:db,ste:Pa},ja),this.Wff(),f.ULS.sendTraceTag(523337866,0,50,`AugmentationLoopAnnotationValidator.onAnnotationReceived: done ${this.getStatus()}`))}vyd(db,Pa){return`${db}_${Pa}`}getStatus(){var db,Pa;const ja=b(this.S6b),Ka=null===(db=this.vNa)||void 0===db?void 0:db.size;db=null===(Pa=this.VOa)||void 0===Pa?void 0:Pa.size;return`current coauth version: ${ja}, ${Ka} known annotations, ${db} coauth versions on hold`}KIb(db,Pa,ja,Ka){const ub=this.vNa.get(`${Pa}`);db=this.vyd(db,
ub.annotationType);f.ULS.sendTraceTag(523337865,0,50,`AugmentationLoopAnnotationValidator.raiseAnnotationEvent: ${ja} raising ${db} event (annotation id: ${Pa})`);this.raiseEvent(db,ub.ste,this);u.EwaSettings.isChangeGateEnabled("OfficeVSO:6807759_AugmentationLoopAnnotationValidatorLoggerEnabled")&&this.H1d.eOi(ub.annotationType,`${Pa}`,Ka)}Fri(db,Pa){Pa=b(this.OWe(Pa));db=`${new Ga(db,Pa)}`;return!this.vNa.has(db)}NJg(db,Pa){var ja=db.ste.BG.id;const Ka=b(Pa);ja=new Ga(ja,Ka);const ub=`${ja}`;this.vNa.has(ub)?
f.ULS.sendTraceTag(523337864,0,50,`AugmentationLoopAnnotationValidator.addNewAnnotation: ignoring duplicate annotation (annotation id ${ja})`):(this.vNa.set(ub,db),this.b_.has(Ka)?this.b_.get(Ka).wGa.add(ja.annotationId):this.b_.set(Ka,{wGa:new Set([ja.annotationId]),timestamp:Date.now()}),this.KIb("New",ja,"addNewAnnotation","New"),db=this.S6b,Pa===db||Pa&&db&&Pa.DocId===db.DocId&&Pa.Xluid===db.Xluid&&Pa.Xrevid===db.Xrevid?this.KIb("Valid",ja,"addNewAnnotation","ValidOnArrival"):this.VOa.add(b(Pa)))}kVf(db){this.vNa.delete(`${db}`);
for(let [Pa,ja]of this.b_.entries())if(Pa===db.coauthVersion&&ja.wGa.delete(db.annotationId))break}Sij(){Array.from(this.b_.entries()).filter(([,db])=>0===db.wGa.size).forEach(([db])=>this.b_.delete(db))}rVf(db){this.VOa.delete(db)}Aki(db){var Pa;const ja=b(db);(new Set(null===(Pa=this.b_.get(ja))||void 0===Pa?void 0:Pa.wGa)).forEach(Ka=>{Ka=new Ga(Ka,ja);this.KIb("Invalid",Ka,"invalidateAnnotations","InvalidOnCoauthVersionChanged");this.kVf(Ka)})}K4j(db){var Pa;db=b(db);if(this.VOa.has(db)){var ja=
null===(Pa=this.b_.get(db))||void 0===Pa?void 0:Pa.wGa;Pa=(Pa=this.b_.get(db))?Date.now()-Pa.timestamp:0;for(const Ka of ja)ja=new Ga(Ka,db),this.KIb("Valid",ja,`validateAnnotations elapsed ${Pa} ms`,"ValidAfterSomeTime");this.rVf(db)}else f.ULS.sendTraceTag(523337863,0,50,`AugmentationLoopAnnotationValidator.validateAnnotations: ${db} has no on-hold annotations associated with it`)}Wff(){var db=Date.now();const Pa=[],ja=[];for(const ub of this.VOa){var Ka=this.b_.get(ub);const Kb=db-Ka.timestamp;
if(Kb>this.CWe)for(const W of Ka.wGa)Ka=new Ga(W,ub),this.KIb("Invalid",Ka,`invalidateExpiredAnnotations elapsed ${Kb} ms`,"InvalidAfterTimeout"),Pa.push(Ka)}for(const ub of Pa)this.kVf(ub);for(const ub of this.VOa)db=this.b_.get(ub),0===(null===db||void 0===db?void 0:db.wGa.size)&&ja.push(ub);for(const ub of ja)this.rVf(ub);this.Sij()}}Object(r.a)(tb,"AugmentationLoopAnnotationValidator",l.a,[282]);class wb extends F.a{constructor(db){super();this.augmentationLoopManager=null;this.$=db;this.Db();
f.ULS.sendTraceTag(520939607,0,50,"AugmentationLoopManagerFactory.constructor: called")}create(){const db=Date.now();d.Health.instance.recordKpiUsageForAlertableKpi("AugmentationLoopManagerCreation","xlalint",null);f.ULS.sendTraceTag(537170371,0,50,"AugmentationLoopManagerFactory.create: called");let Pa=null;const ja=[];u.EwaSettings.ra(379)&&(Pa=Ya.GetServiceTaskFactory.Oa(this.$.da,349,350,this.Xa),ja.push(Pa));Gb.TaskExtensions.za(Gb.TaskExtensions.Fd(ja,this.la,3),()=>{Ha.vAi(this.$,Pa?Pa.result:
null,this.Xa).then(Ka=>{f.ULS.sendTraceTag(537170370,0,50,"AugmentationLoopManagerFactory.create: Augmentation Loop runtime initialized");try{this.nb(this.augmentationLoopManager||(this.augmentationLoopManager=new ka(this.$,Ka,new tb(this.$.ya.AugmentationLoopAnnotationExpirationTimeoutInMs)))),Ha.Nxj(this.augmentationLoopManager.Soc)}catch(ub){d.Health.instance.recordKpiFailure("AugmentationLoopManagerCreation","Exception",!1,!0,Object(e.a)(new Ja.a,{extendedProperties:new Map,durationMs:Date.now()-
db})),this.nb(null),f.ULS.sendTraceTag(42796228,0,10,`AugmentationLoopManagerFactory.create: Augmentation loop initialization failed. Exception ${ub.message}`)}}).catch(()=>{d.Health.instance.recordKpiFailure("AugmentationLoopManagerCreation","PromiseRejected",!1,!0,Object(e.a)(new Ja.a,{extendedProperties:new Map,durationMs:Date.now()-db}));this.nb(null);f.ULS.sendTraceTag(42796229,0,10,"AugmentationLoopManagerFactory.create: Augmentation loop initialization failed")})},this.$.la,3)}static ka(db){f.ULS.sendTraceTag(520939606,
0,50,"AugmentationLoopManagerFactory.attach: called");db.da.Ha(327,new wb(db))}}Object(r.a)(wb,"AugmentationLoopManagerFactory",F.a,[]);var lb=a(9);a=a(1183);Type.registerNamespace("_Ewa");(()=>{lb.a.Fa(db=>{wb.ka(db)})})();Object(a.a)()},835:function(r,F,a){a.d(F,"h",function(){return d});a.d(F,"g",function(){return l});a.d(F,"f",function(){return k});a.d(F,"b",function(){return t});a.d(F,"c",function(){return n});a.d(F,"e",function(){return z});a.d(F,"d",function(){return w});a.d(F,"a",function(){return u});
r=a(0);var c=a(11),b=a(322),e=a(15),f=a(33);const d=(x,B,H,I)=>{e.ULS.sendTraceTag(221794372,306,20,`FormulaByExample suggestion display failure reported. Failure data ${JSON.stringify({["flowId"]:x.flowId,["originFormulaFlowId"]:x.Lca.flowId,["formulaAnonymized"]:x.anonymizedFormula,["originalFormulaAnonymized"]:x.Lca.anonymizedFormula,["range"]:x.range,["failureReason"]:B})}`);H&&H.xo(x.flowId,I,{reason:B})};var h;(function(x){x.EXAMPLE="EXAMPLE";x.MODIFIEDEXAMPLE="MODIFIEDEXAMPLE";x.RESTOFRANGE=
"RESTOFRANGE";x.MODIFIEDRESTOFRANGE="MODIFIEDRESTOFRANGE"})(h||(h={}));Object(r.b)("suggestionCellType",h);const l=(x,B,H,I,U,S)=>{e.ULS.sendTraceTag(512350163,0,50,`Cell data didn't match suggestion output on FlowId: ${U.flowId}. cellType: ${S} caller: ${I}:
      CellData: ${C(x)}, CellFormatIndex: ${H}, SuggestionOutput: ${C(B)},
      SuggestedFormula: ${U.anonymizedFormula}}`)},k=(x,B,H)=>{try{const I=y(x,B,H);window.performance.mark(I)}catch(I){e.ULS.sendTraceTag(529109767,0,10,`FormulaByExampleTelemetryGenerator.markPerformancePoint: Error thrown : ${I.message}`)}},t=x=>{for(const B in m)try{window.performance.clearMarks(y(B,x,!1)),window.performance.clearMarks(y(B,x,!0))}catch(H){e.ULS.sendTraceTag(527005662,0,10,`FormulaByExampleTelemetryGenerator.clearPerformanceFlowMarks: Error thrown : ${H.message}`)}},n=x=>v(`FBE_flowCurrentDuration_${x}`,
y(m.EditCommit,x,!1)),z=(x,B)=>{try{return{["EditCommitToSignal"]:v(`FBE_EditCommitToSignal_${B}_${x}`,y(m.EditCommit,B,!1),y(m.SignalSent,B,!1)),["WorkflowAndNetworkTime"]:x?0:v(`FBE_WorkflowAndNetworkTime_${B}_${x}`,y(m.SignalSent,B,!1),y(m.AnnotationReceived,B,!1)),["Calculation"]:v(`FBE_Calculation_${B}_${x}`,y(m.CalculationStart,B,x),y(m.CalculationEnd,B,x)),["ModelUpdate"]:v(`FBE_ModelUpdate_${B}_${x}`,y(m.CalculationEnd,B,x),y(m.ModelUpdated,B,x)),["PreviewRender"]:v(`FBE_PreviewRendered_${B}_${x}`,
y(m.ModelUpdated,B,x),y(m.PreviewRendered,B,x)),["Total"]:v(`FBE_Total_${B}_${x}`,y(m.EditCommit,B,!1),y(m.PreviewRendered,B,x))}}catch(H){e.ULS.sendTraceTag(529109766,0,10,`FormulaByExampleTelemetryGenerator.getPreviewShownDurations: Error thrown : ${H.message}`)}},w=(x,B)=>{try{return{["UserInPreviewDuration"]:v(`FBE_InputToPreviewRemovedWithCSE_${B}_${x}`,y(m.PreviewRendered,B,x),y(m.UserInputArrived,B,x)),["InputToPreviewRemovedWithCSE"]:v(`FBE_InputToPreviewRemovedWithCSE_${B}_${x}`,y(m.UserInputArrived,
B,x),y(m.PreviewRemovedWithCSE,B,x))}}catch(H){e.ULS.sendTraceTag(529109765,0,10,`FormulaByExampleTelemetryGenerator.getPreviewRemovedDurations: Error thrown : ${H.message}`)}};var m;(function(x){x.EditCommit="EDITCOMMIT";x.SignalSent="SIGNALSENT";x.AnnotationReceived="ANNOTATIONRECEIVED";x.CalculationStart="CALCULATIONSTART";x.CalculationEnd="CALCULATIONED";x.ModelUpdated="MODELUPDATED";x.PreviewRendered="PREVIEWRENDERED";x.UserInputArrived="USERINPUTARRIVED";x.PreviewRemovedWithCSE="PREVIEWREMOVEDWITHCSE"})(m||
(m={}));Object(r.b)("FormulaByExampleFlowMarks",m);const u=x=>c.HelperMethods.X_c&&b.a.kqb&&f.a.Lka(x),y=(x,B,H)=>`${x}_${B+(H?"_cached":"")}`,v=(x,B,H)=>{const I=window.performance.measure(x,B,H);if(I)return B=I.duration,performance.clearMeasures(x),B;e.ULS.sendTraceTag(526984791,0,15,`FormulaByExampleTelemetryGenerator.measureTime: could not find performance entry for measure: ${x}, startMark: ${B}, endMark: ${H}`);return-1},C=x=>x.replace(RegExp("[0-9a-zA-Z]","g"),B=>"a"<=B&&"z">=B?"a":"A"<=B&&
"Z">=B?"A":"0"<=B&&"9">=B?"9":B)},870:function(r,F,a){r=a(0);var c=a(15),b=a(427),e=a(1),f;(function(I){I[I.UserEditedInTable=0]="UserEditedInTable";I[I.FormulaByExampleNoTrigger=1]="FormulaByExampleNoTrigger";I[I.FlowInterrupted=2]="FlowInterrupted";I[I.FormulaByExampleFullTrigger=3]="FormulaByExampleFullTrigger";I[I.HadCachedSuggestion=4]="HadCachedSuggestion";I[I.NoCachedSuggestion=5]="NoCachedSuggestion";I[I.PreCalcPreviewRejected=6]="PreCalcPreviewRejected";I[I.WaitingForCalcResult=7]="WaitingForCalcResult";
I[I.PostCalcPreviewRejected=8]="PostCalcPreviewRejected";I[I.SuggestionDidntMatch=9]="SuggestionDidntMatch";I[I.SuggestionMatched=10]="SuggestionMatched";I[I.PreviewShouldBeShown=11]="PreviewShouldBeShown";I[I.SignalSent=12]="SignalSent";I[I.NoSignalSent=13]="NoSignalSent";I[I.AnnotationReceived=14]="AnnotationReceived";I[I.NoFormulaFound=15]="NoFormulaFound";I[I.FormulaFound=16]="FormulaFound";I[I.WorkbookClosed=17]="WorkbookClosed";I[I.UnexpectedTransition=18]="UnexpectedTransition"})(f||(f={}));
Object(r.b)("FormulaByExampleFlowState",f);const d=new Map([[f.UserEditedInTable,[f.FormulaByExampleNoTrigger,f.FormulaByExampleFullTrigger]],[f.FormulaByExampleFullTrigger,[f.FlowInterrupted,f.NoCachedSuggestion,f.HadCachedSuggestion]],[f.NoCachedSuggestion,[f.NoSignalSent,f.SignalSent]],[f.HadCachedSuggestion,[f.PreCalcPreviewRejected,f.WaitingForCalcResult]],[f.PreCalcPreviewRejected,[f.NoSignalSent,f.SignalSent]],[f.WaitingForCalcResult,[f.NoSignalSent,f.SignalSent]]]),h=new Set([f.FormulaByExampleNoTrigger,
f.FlowInterrupted,f.NoSignalSent,f.SignalSent]),l=new Map([[f.PreCalcPreviewRejected,[f.SuggestionDidntMatch,f.SuggestionMatched]]]),k=new Set([f.SuggestionDidntMatch,f.SuggestionMatched]),t=new Map([[f.WaitingForCalcResult,[f.PostCalcPreviewRejected,f.SuggestionDidntMatch,f.SuggestionMatched]],[f.SuggestionDidntMatch,[f.PostCalcPreviewRejected,f.PreviewShouldBeShown]],[f.SuggestionMatched,[f.PostCalcPreviewRejected,f.PreviewShouldBeShown]]]),n=new Set([f.PostCalcPreviewRejected,f.PreviewShouldBeShown]),
z=new Map([[f.SignalSent,[f.AnnotationReceived]],[f.AnnotationReceived,[f.NoFormulaFound,f.FormulaFound]],[f.FormulaFound,[f.PreCalcPreviewRejected,f.WaitingForCalcResult]]]),w=new Set([f.NoFormulaFound,f.FormulaFound]),m=new Set([f.NoFormulaFound,f.PreCalcPreviewRejected,f.WaitingForCalcResult]);var u;(function(I){I[I.Initial=0]="Initial";I[I.Pending=1]="Pending";I[I.Resolved=2]="Resolved"})(u||(u={}));Object(r.b)("SignalState",u);var y=a(161);class v{constructor(I,U,S){this.currentState=I;this.oOj=
U;this.OGh=S}mua(I){const U=this.oOj.get(this.currentState);return U&&U.includes(I)?(this.currentState=I,!0):!1}get isActive(){return!this.OGh.has(this.currentState)}ejd(){return f[this.currentState]}}Object(r.a)(v,"FormulaByExampleStateMachine",null,[]);class C{constructor(I,U,S,G,D){this.xSi=D;this.Xqc=new v(0,d,h);this.S3={flowId:I,O6g:U,qrj:S,Sfb:G,Snc:null,TYe:!1,eRd:!1,MSa:0,UYe:{},gBe:new Set}}get MSa(){return this.S3.MSa}set flowId(I){this.S3.flowId=I}Moc(I){this.S3.gBe.add(I)}mua(I,U){17===
I?this.H9():(this.v9b(I,U),this.yQg())}H9(){this.xSi(this.S3)}v9b(I,U){var S,G;this.Xqc.mua(I)?this.FXi(I):(null===(S=this.S_a)||void 0===S?0:S.mua(I))?this.SOi(I):(null===(G=this.hAc)||void 0===G?0:G.mua(I))?this.x_i(I,U):this.NVi(I,U);(I=this.L4e(I))&&this.epe(I,U)}FXi(I){switch(I){case 2:this.S3.TYe=!0;break;case 6:this.S_a=new v(I,l,k);break;case 7:this.S_a=new v(I,t,n);break;case 12:this.S3.MSa=1,this.hAc=new v(I,z,e.EwaSettings.isChangeGateEnabled("OfficeVSO:6169955_ShowFormulaByExampleSuggestionsUponArrivalFromServer")?
m:w)}}SOi(I){switch(I){case 9:this.S3.eRd=!1;break;case 10:this.S3.eRd=!0}}x_i(I,U){switch(I){case 14:this.S3.MSa=2;break;case 16:this.S3.Snc=U?U.Snc:null;break;case 7:this.S_a=new v(I,t,n)}}NVi(I,U){this.epe(this.L4e(18),{reason:`${`Tried to change state from ${this.Awj()} to ${f[I]}`}.${this.y6e(U)}`});this.H9()}yQg(){var I,U;this.Xqc.isActive||(null===(I=this.S_a)||void 0===I?0:I.isActive)||(null===(U=this.hAc)||void 0===U?0:U.isActive)||this.H9()}epe(I,U){if(U=this.y6e(U))I.explanation||(I.explanation=
""),I.explanation+=U;U=I.name;I=Object(y.d)(I,["name"]);this.S3.UYe[U]=I}y6e(I){return null!=I&&null!=I.reason?" "+I.reason:""}Awj(){var I,U;const S=`OriginStateMachine: ${this.Xqc.isActive?this.Xqc.ejd():"NotActive"}`,G=`CalcStateMachine: ${(null===(I=this.S_a)||void 0===I?0:I.isActive)?this.S_a.ejd():"NotActive"}`;I=`SignalStateMachine: ${(null===(U=this.hAc)||void 0===U?0:U.isActive)?this.hAc.ejd():"NotActive"}`;return`[${S}, ${G}, ${I}]`}L4e(I){switch(I){case 1:return this.ZT("FBEFullTrigger",
!1);case 3:return this.ZT("FBEFullTrigger",!0);case 5:return this.ZT("CachedSuggestion",!1);case 4:return this.ZT("CachedSuggestion",!0);case 6:return this.ZT("PreviewShouldBeShown",!1,"Before calling calc evaluation");case 8:return this.ZT("PreviewShouldBeShown",!1,"After returning from Calc");case 9:return this.ZT("SetCellMatchedSuggestion",!1);case 10:return this.ZT("SetCellMatchedSuggestion",!0);case 11:return this.ZT("PreviewShouldBeShown",!0);case 8:return this.ZT("PreviewShouldBeShown",!1,
"After returning from Calc");case 15:return this.ZT("FormulaFound",!1);case 16:return this.ZT("FormulaFound",!0);case 18:return this.ZT("UnexpectedTransition",!0)}return null}ZT(I,U,S){return S?{name:I,value:U,explanation:S}:{name:I,value:U}}}Object(r.a)(C,"FormulaByExampleFlowDataAggregator",null,[]);a.d(F,"b",function(){return-1});a.d(F,"a",function(){return x});class x{static getInstance(I){this.instance||(e.EwaSettings.isChangeGateEnabled("OfficeVSO:7041480_FormulaByExampleFlowAggregatorFixed")?
this.instance=B.getInstance(I):this.instance=H.getInstance(I));return this.instance}}Object(r.a)(x,"FormulaByExampleFlowsTrackerFactory",null,[]);class B{constructor(I){this.nextId=1;this.Pff=this.tPb=0;this.EU=new Map;this.SXd=new Map;this.uEe=new Map;this.uc=()=>{const U=this.M_h();if(0!==U.size){this.$.sendBeaconTraceTag(526984790,50,!1,`some pending FBE flows were not resolved by workbook closure. Total flows amount in sessions: ${this.tPb}, Unresolved flows amount: ${U.size}, pending flows: ${[...U].join()}, interrupted flows amount ${this.Pff}`);
for(const S of U)this.xo(S,17)}};this.QPj=U=>{const S=U.flowId;var G=U.O6g;const D=U.qrj,E=U.Sfb,N=U.Snc,M=U.TYe,L=U.eRd,aa=U.MSa,V=U.UYe,P=U.gBe,ba=this.D5e(G);U=ba.Ipf;const Y=U!==N;Y&&(ba.Zcg++,ba.Ipf=N);L&&ba.DOe++;M&&this.Pff++;2===aa&&this.tPb++;G={["flowId"]:S,["columnKey"]:G,["rowNumber"]:D,["triggerCommand"]:Object(b.a)(E),["flowDataAggergation"]:V,["editOperationsInColumn"]:ba.vOe,["suggestionChangesInColumn"]:ba.Zcg,["gotNewSuggestion"]:Y,["matchedSuggestionsInColumn"]:ba.DOe,["cellCycleColumns"]:Array.from(P).sort(),
["rowsEditedInColumn"]:Array.from(ba.BOe).sort()};c.ULS.sendTraceTag(512365781,0,null!=U||null!=N?20:50,`FormulaByExampleFlowsTracker.summarizeFlowOverallData: Flow Aggregation results: ${JSON.stringify(G)}`);this.EU.set(S,void 0)};this.$=I;this.$.nj(this.uc)}static getInstance(I){B.instance||(B.instance=new B(I));return B.instance}c5e(){const I=this.nextId++,U=this.EU.get(-1);U?(U.flowId=I,this.EU.set(I,U),this.EU.delete(-1)):c.ULS.sendTraceTag(512503829,0,15,`FormulaByExampleFlowsTracker.getNewFlowId: on flowId ${I} called getNewFlowId without having matched anonymousFlow`);
return I}Nif(I){const U=this.EU.has(I),S=this.EU.get(I),G=S&&1===S.MSa;let D;U?S?G||(D="The flow exists but is not pending for annotation"):D="Flow was resolved already":D="This flow does not exist";D&&c.ULS.sendTraceTag(509650145,306,50,`FormulaByExampleManager.formulaByExampleAnnotationHandler: flow is not pending for annotation. ${D} flowId: ${I}`);return G}pCf(I,U,S,G){this.EU.get(-1)&&(this.xo(-1,2),this.EU.delete(-1));U=this.FRh(U,S);S=this.D5e(U);S.vOe++;S.BOe.add(G);this.EU.set(-1,new C(-1,
U,G,I,this.QPj))}Moc(I,U){const S=this.EU.get(I);S?S.Moc(U):this.sYf("onCellCycleFound",I)}xo(I,U,S){const G=this.EU.get(I);G?G.mua(U,S):this.sYf("notifyFlowReachedState",I,U)}FRh(I,U){let S=this.SXd.get(I);void 0===S&&(S=this.SXd.size,this.SXd.set(I,S));return S+"_"+U}M_h(){const I=new Set;for(const [U,S]of this.EU)1===(null===S||void 0===S?void 0:S.MSa)&&I.add(U);return I}D5e(I){let U=this.uEe.get(I);U||(U={vOe:0,DOe:0,Zcg:0,Ipf:null,BOe:new Set},this.uEe.set(I,U));return U}sYf(I,U,S){const G=this.EU.has(U);
c.ULS.sendTraceTag(509678805,0,15,`FormulaByExampleFlowsTracker.${I}:
       on flowId ${U} ${S?` transition to ${f[S]}`:""}, `+"flowIdsToAggregatorsMap didn't find the requested flowAggregatoror. "+`Did flow exist: ${G}`)}}Object(r.a)(B,"FormulaByExampleFlowsTracker",null,[356]);class H{constructor(I){this.nextId=1;this.Fvb=new Set;this.tPb=0;this.uc=()=>{let U=this.Fvb.size;0!==U&&this.$.sendBeaconTraceTag(526984790,50,!1,"some pending FBE flows were not resolved by workbook closure. Total flows amount in sessions: {0}, Unresolved flows amount: {1}, pending flows: {2}",
this.tPb,U,[...this.Fvb].join())};this.$=I;this.$.nj(this.uc)}static getInstance(I){H.instance||(H.instance=new H(I));return H.instance}Nif(I){return this.Fvb.has(I)}pCf(){}Moc(){}xo(I,U){switch(U){case 12:this.Pyj(I);break;case 14:this.Qyj(I)}}c5e(){return this.nextId++}Pyj(I){this.Fvb.add(I);this.tPb++}Qyj(I){this.Fvb.delete(I)}}Object(r.a)(H,"FormulaByExampleFlowsTrackerDeprecated",null,[356])},886:function(r,F,a){a.d(F,"a",function(){return 2})}}]);

//# sourceMappingURL=https://artifacts.dev.azure.com/office/_apis/symbol/symsrv/EwaDSEsNext.augmentationloop.js.map/523f18b5e5bce3600e15fd77dcefbb01/EwaDSEsNext.augmentationloop.js.map